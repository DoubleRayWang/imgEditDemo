Object.defineProperty(Array.prototype,"del",{set:function(t){},get:function(){return function(t){t.sort(function(t,a){return t-a});for(var a=this.concat([]),e=t.length-1;e>=0;e--)a=a.slice(0,t[e]).concat(a.slice(t[e]+1));return a}},enumerable:!1,configurable:!1});try{HTMLImageElement.prototype.loadOnce=function(t){var a=0;this.onload=function(){a||t.call(this,null),a++}}}catch(t){window={}}(function(t){function a(){this.readyState&&(this.readyState=0,this.dorsyWorker.startWorker())}var e=function(){if(window.navigator){var t=window.navigator.userAgent;return/Android|android/.test(t)?"android":/iPhone|iPad|iPod/.test(t)?"ios":"other"}return"sandBox"}(),r={lib:[],definedPs:{},init:function(){this.require("config")},module:function(t,a){function e(t){var o=r[++n];n!=r.length-1?e(t[o]?t[o]:t[o]={}):t[o]=a.call(null,i)}var r=[t];/\./g.test(t)&&(r=t.split("."));var n=-1,i=this;e(this.lib)},require:function(t){var a=this,e=document.createElement("script");document.body.appendChild(e),e.src="./js/module/"+t+".js",e.onload=e.onerror=function(t){a.handlerror(t)}},handlerror:function(t){},destroySelf:function(a){throw delete window[t],new Error(a)},reflect:function(t,a,e){var r=this.lib.config.getModuleName(t),n=r.spaceName,i=r.actName;switch(n){case"Filter":case"Alteration":return this.lib[n][i].process(a,e);case"ComEffect":return this.lib[i].process(a,e);default:this.destroySelf("AI_ERROR: ")}},reflectEasy:function(t){var a=this.lib.config.getEasyFun(t).actName;return this.definedPs[t]||this.lib.easy.getFun(a)},add:function(t,a,e,r,n,i,o,s){return this.lib.addLayer.add(t,a,e,r,n,i,o,s)},worker:function(t,a){},applyMatrix:function(t,a){},tools:function(t,a){var e=Array.prototype.shift.call(a);if(this.lib.Tools[e])return this.lib.Tools[e].process(t,a);throw new Error("AI_ERROR: 不存在的工具方法_"+e)},definePs:function(t,a){this.definedPs[t]=a}};window[t]=function(a,n,i){var o=this;if(!(this instanceof window[t]))return new window[t](a,n,i);this.startTime=+new Date;var s=document.createElement("canvas"),h=s.getContext("2d");if(isNaN(a))if("string"==typeof a){var c=new Image;c.onload=function(){s.width=parseInt(this.width),s.height=parseInt(this.height),h.drawImage(this,0,0,this.width,this.height)},c.src=a}else{var u=n,d=i,f=a.width,l=a.height,v=f/l;n||i?i?n||(u=d*v):d=~~(u/v):(u=f,d=l),s.width=u,s.height=d,isNaN(u)?h.drawImage(a,0,0):"ios"==e?r.lib.Fix.drawImageIOS(h,a,u,d):h.drawImage(a,0,0,u,d),this.srcImg=a}else s.width=a,s.height=n,i=i||"#fff",h.fillStyle=i,h.fillRect(0,0,a,n),this.srcImg="";this.canvas=s,this.context=h,this.imgData=h.getImageData(0,0,s.width,s.height),this.name=t+"_"+Math.random(),this.canvas.id=this.name,this.layers=[];var g=document.createElement("canvas");if(g.width=s.width,g.height=s.height,this.ctxCanvas=g,this.ctxContext=s.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.useWorker=r.useWorker,this.readyState=1,this.useWorker&&(this.dorsyWorker=r.lib.dorsyWorker(this)),r.lib.Tools)for(var w in r.lib.Tools)this.Tools[w]=function(t){return function(a){return o.Tools(t,a)}}(w)},window[t].module=function(t,a){r.module(t,a)},window[t].dorsyMath=function(){return r.lib.dorsyMath},window[t].setName=function(t){r.name=t||"alloyimage.js"},window[t].getConfig=function(){return r.lib.config.getConfig()},window[t].define=function(t,a){r.definePs(t,a)},window[t].useWorker=function(t){if(!window.Worker)return this.useWorker=0,void console.log("AI_WARNING: 浏览器不支持web worker, 自动切换为单线程\nAI_WARNING: the brower doesn't support Web Worker");var t=t||"";/[\/\\]$/.test(t)&&(t+=r.name),""==t&&(t="alloyimage.js"),r.useWorker=1,r.path=t;var a=new XMLHttpRequest;a.onreadystatechange=function(){4==a.readyState&&"404"==a.status&&r.destroySelf("AI_ERROR：使用worker时，ai文件路径指定错误\nAI_ERROR: error occured while using web worker since indicate the wrong path of file ai")},a.open("GET",t,!1),a.send()},onmessage=function(t){var a,e=t.data;"act"==e[0]?a=r.reflect(e[1],e[2],e[3]):"add"==e[0]&&(a=r.add.apply(r,e[1])),postMessage(a)},window[t].prototype={set width(t){this.canvas.width=t},set height(t){this.canvas.height=t},get width(){return this.canvas.width},get height(){return this.canvas.height},act:function(t,e){var n=[];return n=Array.prototype.slice.call(arguments,1),this.useWorker?(this.dorsyWorker.queue.push(["act",t,n]),a.call(this)):r.reflect(t,this.imgData,n),this},view:function(t,a,e,r,n){var i=this.clone();return i.type=1,this.addLayer(i,"正常",0,0),i.act(t,a,e,r,n),this},excute:function(){var t=this.layers,a=t.length;t[a-1]&&1==t[a-1][0].type&&(this.imgData=t[a-1][0].imgData,delete t[a-1])},cancel:function(){var t=this.layers,a=t.length;t[a-1]&&1==t[a-1][0].type&&delete t[a-1]},show:function(a,e,r){if(!r&&this.useWorker)return this.dorsyWorker.queue.push(["show",a,e]),this;if(0==this.layers.length)this.tempPsLib={imgData:this.imgData};else{var n=new window[t](this.canvas.width,this.canvas.height);n.add(this,"正常",0,0,e),this.tempPsLib=n;for(var i=0;i<this.layers.length;i++){var o=this.layers[i],s=o[0].layers,h=o[0];s[s.length-1]&&1==s[s.length-1][0].type&&(h=s[s.length-1][0]),n.add(h,o[1],o[2],o[3],e)}this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}return this.context.putImageData(this.tempPsLib.imgData,0,0),a?"string"==typeof a?document.querySelector(a).appendChild(this.canvas):a.appendChild(this.canvas):document.body.appendChild(this.canvas),this},replaceChild:function(t){var a;return a="string"==typeof t?document.querySelector(t):t,a.innerHTML="",this.show(a)},replace:function(t,e){return!e&&this.useWorker?(this.dorsyWorker.queue.push(["replace",t]),a.call(this),this):(t&&(t.onload=function(){},t.src=this.save(0,1,e)),this)},add:function(){for(var t,e,n,i,o,s,h,c=[],u=0;u<arguments.length;u++)if(u)switch(typeof arguments[u]){case"string":/\d+%/.test(arguments[u])?n=arguments[u].replace("%",""):/[RGB]+/.test(arguments[u])?h=arguments[u]:e=arguments[u];break;case"number":c.push(arguments[u]);break;case"boolean":s=arguments[u]}return i=c[0]||0,o=c[1]||0,e=e||"正常",n=n/100||1,s=s||!1,h=h||"RGB",t=arguments[0],this.useWorker?(this.dorsyWorker.queue.push(["add",t,e,n,i,o,s,h]),a.call(this)):r.add(this.imgData,t.imgData,e,n,i,o,s,h),this},addLayer:function(t,a,e,r){return this.layers.push([t,a,e,r]),this},clone:function(a){var e=new window[t](this.canvas.width,this.canvas.height);return e.context.putImageData(this.imgData,0,0),e.imgData=e.context.getImageData(0,0,this.canvas.width,this.canvas.height),e},swap:function(t,a){var e=this.layers[t];return this.layers[t]=this.layers[a],this.layers[a]=e,this},deleteLayers:function(t){this.layers=this.layers.del(t)},save:function(e,r,n){e=(e=e||"png").toLowerCase(),r=r||.8,"jpg"==e&&(e="jpeg");var i="image/"+e;if(!n&&this.useWorker)return this.dorsyWorker.queue.push(["save"]),a.call(this),this;if(!this.layers.length)return this.context.putImageData(this.imgData,0,0),this.canvas.toDataURL(i,r);var o=new window[t](this.canvas.width,this.canvas.height);o.add(this,"正常",0,0,isFast),this.tempPsLib=o;for(var s=0;s<this.layers.length;s++){var h=this.layers[s],c=h[0].layers,u=h[0];c[c.length-1]&&1==c[c.length-1][0].type&&(u=c[c.length-1][0]),o.add(u,h[1],h[2],h[3],isFast)}return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.putImageData(o.imgData,0,0),this.canvas.toDataURL(i,r)},saveFile:function(t,a){t=t||"AlloyImage合成图像.jpg",a=a||1;var e=/.*.(jpg|png|gif|jpeg)$/g,r="png";e.test(t)?(e.lastIndex=0,r=e.exec(t)[1]):t+=".png";var n=this.save(r,a),i=document.createElement("a");i.href=n,i.download=t;var o=document.createEvent("HTMLEvents");o.initEvent("click",!1,!1),i.dispatchEvent(o)},download:function(t,a){this.saveFile(t,a)},saveAsDataURL:function(){},saveAsBlob:function(){},saveAsBuffer:function(){},drawRect:function(t){var a;(a=document.getElementById("imgRect"))||(a=document.createElement("canvas"),a.id="imgRect",document.body.appendChild(a),a.width=parseInt(this.canvas.width),a.height=parseInt(this.canvas.height));var e=a.getContext("2d");e.clearRect(0,0,a.width,a.height);for(var r=[],n=this.tempPsLib.imgData.data,i=0,o=n.length;i<o;i++)r[n[i]]?r[n[i]]++:r[n[i]]=1;e.beginPath(),e.moveTo(0,a.height);for(var s=0,i=0;i<255;i++)r[i]>s&&(s=r[i]);for(i=0;i<255;i++){var h=r[i]||0;h=a.height-h/s*.8*a.height,e.lineTo(i/256*a.width,h,1,1)}e.lineTo(a.width+10,a.height),e.fill()},ps:function(t){return"原图"==t||"origin"==t||""==t?this:r.reflectEasy(t).call(this,this.canvas)},logTime:function(t){},ctx:function(t){var a=this.ctxContext;return a.putImageData(this.imgData,0,0),t.call(a),this.imgData=a.getImageData(0,0,this.canvas.width,this.canvas.height),this},notify:function(t){"readyStateOK"==t&&(this.readyState=1)},complete:function(t){this.useWorker?this.dorsyWorker.queue.push(["complete",t]):t()},transform:function(a,e,r){var n=window[t].dorsyMath(),i=this.ctxContext;i.putImageData(this.imgData,0,0);for(var o=document.createElement("canvas").getContext("2d"),s=[new n.Matrix([0,0],"1*2"),new n.Matrix([0,this.canvas.height],"1*2"),new n.Matrix([this.canvas.width,0],"1 * 2"),new n.Matrix([this.canvas.width,this.canvas.height],"1*2")],h=[],c=new n.Matrix(a,"2*2"),u=0;u<s.length;u++)h.push(s[u].mutiply(c));var d=Math.max(h[0].data[0][0],h[1].data[0][0],h[2].data[0][0],h[3].data[0][0]),f=Math.min(h[0].data[0][0],h[1].data[0][0],h[2].data[0][0],h[3].data[0][0]),l=Math.max(h[0].data[0][1],h[1].data[0][1],h[2].data[0][1],h[3].data[0][1]),v=Math.min(h[0].data[0][1],h[1].data[0][1],h[2].data[0][1],h[3].data[0][1]),g=~~(d-f),w=~~(l-v);return o.canvas.width=g,o.canvas.height=w,o.translate(-f,-v),o.transform.apply(o,a),o.drawImage(i.canvas,0,0),this.canvas.width=g,this.canvas.height=w,this.width=g,this.height=w,this.imgData=o.getImageData(0,0,g,w),this},scale:function(t,a){var a=a||t;return this.transform([t,0,0,a,0,0])},scaleTo:function(t,a){var e,r,n=this.width,i=this.height;if(a||(a=t*i/n),t||(t=a*(n/i)),t&&a)return e=t/n,r=a/i,this.scale(e,r)},rotate:function(t){var a=t/180*Math.PI,e=[Math.cos(a),Math.sin(a),-Math.sin(a),Math.cos(a),0,0];return this.transform(e)},moveTo:function(t,a){return t=t||0,a=a||0,this.transform([1,0,0,1,t,a])},clip:function(t,a,e,r){return this.ctxContext.putImageData(this.imgData,0,0),this.imgData=this.ctxContext.getImageData(t,a,e,r),this.context.canvas.width=e,this.context.canvas.height=r,this},Tools:function(t){return r.tools(this.imgData,arguments)}}})("psLib"),window.AlloyImage=window.$AI=window.psLib,window.psLib.module("addLayer",function(t){return{add:function(t,a,e,r,n,i,o,s){var h=t.data,c=a.data,n=n||0,i=i||0,r=r||1,s=s||"RGB";/[RGB]+/.test(s)||(s="RGB");var u,d=s.replace("R","0").replace("G","1").replace("B","2"),f=t.width,l=t.height,v=(c.length,a.width),g=a.height,w=[d.indexOf("0")>-1,d.indexOf("1")>-1,d.indexOf("2")>-1],p=n,m=n+v,y=i,M=i+g;if(!(p>f||(p<0&&(p=0),m<0||(m>f&&(m=f),y>l||(y<0&&(y=0),M<0))))){M>l&&(M=l);for(var I,b,x=y;x<M;x++){I=x*f,b=(x-i)*v;for(var R=p;R<m;R++)for(var k=4*(I+R),C=4*(b+(R-n)),L=0;L<3&&0!=c[C+3];L++)switch(h[k+3]=c[C+3],e){case"颜色减淡":w[L]&&(u=h[k+L]+h[k+L]*c[C+L]/(255-c[C+L]),h[k+L]=(1-r)*h[k+L]+r*u);break;case"变暗":w[L]&&(u=h[k+L]<c[C+L]?h[k+L]:c[C+L],h[k+L]=(1-r)*h[k+L]+r*u);break;case"变亮":w[L]&&(u=h[k+L]>c[C+L]?h[k+L]:c[C+L],h[k+L]=(1-r)*h[k+L]+r*u);break;case"正片叠底":w[L]&&(u=~~(h[k+L]*c[C+L]/255),h[k+L]=(1-r)*h[k+L]+r*u);break;case"滤色":w[L]&&(u=~~(255-(255-h[k+L])*(255-c[C+L])/255),h[k+L]=(1-r)*h[k+L]+r*u);break;case"叠加":w[L]&&(u=h[k+L]<=127.5?h[k+L]*c[C+L]/127.5:255-(255-h[k+L])*(255-c[C+L])/127.5,h[k+L]=(1-r)*h[k+L]+r*u);break;case"强光":w[L]&&(u=c[C+L]<=127.5?h[k+L]*c[C+L]/127.5:h[k+L]+(255-h[k+L])*(c[C+L]-127.5)/127.5,h[k+L]=(1-r)*h[k+L]+r*u);break;case"差值":w[L]&&(u=h[k+L]>c[C+L]?h[k+L]-c[C+L]:c[C+L]-h[k+L],h[k+L]=(1-r)*h[k+L]+r*u);break;case"排除":w[L]&&(u=h[k+L]+c[C+L]-h[k+L]*c[C+L]/127.5,h[k+L]=(1-r)*h[k+L]+r*u);break;case"点光":w[L]&&(u=h[k+L]<2*c[C+L]-255?2*c[C+L]-255:h[k+L]<2*c[C+L]?h[k+L]:2*c[C+L],h[k+L]=(1-r)*h[k+L]+r*u);break;case"颜色加深":w[L]&&(u=255-255*(255-h[k+L])/c[C+L],h[k+L]=(1-r)*h[k+L]+r*u);break;case"线性加深":w[L]&&(u=(D=h[k+L]+c[C+L])>255?D-255:0,h[k+L]=(1-r)*h[k+L]+r*u);break;case"线性减淡":w[L]&&(u=(D=h[k+L]+c[C+L])>255?255:D,h[k+L]=(1-r)*h[k+L]+r*u);break;case"柔光":w[L]&&(u=c[C+L]<127.5?((2*c[C+L]-255)*(255-h[k+L])/65025+1)*h[k+L]:(2*c[C+L]-255)*(Math.sqrt(h[k+L]/255)-h[k+L]/255)+h[k+L],h[k+L]=(1-r)*h[k+L]+r*u);break;case"亮光":w[L]&&(u=c[C+L]<127.5?255*(1-(255-h[k+L])/(2*c[C+L])):h[k+L]/(2*(1-c[C+L]/255)),h[k+L]=(1-r)*h[k+L]+r*u);break;case"线性光":if(w[L]){var D=h[k+L]+2*c[C+L]-255;u=D>255?255:D,h[k+L]=(1-r)*h[k+L]+r*u}break;case"实色混合":w[L]&&(u=c[C+L]<255-h[k+L]?0:255,h[k+L]=(1-r)*h[k+L]+r*u);break;default:w[L]&&(u=c[C+L],h[k+L]=(1-r)*h[k+L]+r*u)}}return t}}}}),window.psLib.module("applyMatrix",function(t){return{process:function(a,e){for(var r=a.data,n=a.width,i=(a.height,new t.lib.dorsyMath.Matrix([-2,-4,-4,-4,-2,-4,0,8,0,-4,-4,8,24,8,-4,-4,0,8,0,-4,-2,-4,-4,-4,-2],25,1)),o=[],s=0,h=r.length;s<h;s+=4){var c=s/4,u=parseInt(c/n),d=c%n;if(0!=u&&0!=d){for(var f=[[],[],[]],l=-2;l<3;l++)for(var v=u+l,g=-2;g<3;g++)for(var w=4*(v*n+(d+g)),p=0;p<3;p++){var m=w+p;f[p].push(r[m])}for(var y=new t.lib.dorsyMath.Matrix(f,3,matrixSize).mutiply(i),p=0;p<3;p++)o[s+p]=y.data[p];o[s+4]=r[s+4]}}for(var s=0,h=r.length;s<h;s++)r[s]=o[s]||r[s];return a}}}),window.psLib.module("config",function(t){var a={Alteration:{"亮度":"brightness","色相/饱和度调节":"setHSI","曲线":"curve","gamma调节":"gamma","可选颜色":"selectiveColor"},Filter:{"灰度处理":"toGray","反色":"toReverse","灰度阈值":"toThresh","高斯模糊":"gaussBlur","浮雕效果":"embossment","查找边缘":"borderline","马赛克":"mosaic","油画":"oilPainting","腐蚀":"corrode","锐化":"sharp","添加杂色":"noise","暗角":"darkCorner","喷点":"dotted","降噪":"denoise","棕褐色":"sepia","色调分离":"posterize"},ComEffect:{"美肤":"softenFace","素描":"sketch","自然增强":"softEnhancement","紫调":"purpleStyle","柔焦":"soften","复古":"vintage","黑白":"gray","仿lomo":"lomo","亮白增强":"strongEnhancement","灰白":"strongGray","灰色":"lightGray","暖秋":"warmAutumn","木雕":"carveStyle","粗糙":"rough"}},e=function(){var t={};for(var e in a)if("ComEffect"!=e)for(var r in a[e])t[r]=e,t[a[e][r]]=e;return t}();return{getModuleName:function(r){var n;if(n=e[r])return{spaceName:n,actName:a[n][r]||r};t.destroySelf("AI_ERROR:调用AI不存在的方法"+r)},getEasyFun:function(t){return{spaceName:"ComEffect",actName:a.ComEffect[t]||t}},getConfig:function(){return a}}}),window.psLib.module("dorsyMath",function(t){var a={FFT1:function(t){function e(){i++;for(var t=n/Math.pow(2,i),a=n/t,o=0;o<t;o++)r(o*a,(o+1)*a-1,i);t>1&&e()}function r(e,r,i){for(var s=Math.pow(2,i-1),h=e,c=0;h<=r-s;h++){var u=h+s,d=c*n/Math.pow(2,i),f=d+n/4;t[h]instanceof a.C||(t[h]=new a.C(t[h])),t[u]instanceof a.C||(t[u]=new a.C(t[u]));var l=t[h].plus(t[u].mutiply(o[d])),v=t[h].plus(t[u].mutiply(o[f]));t[h]=l,t[u]=v,c++}}for(var n=t.length,i=0,o=[],s=0;s<n;s++)o[s]=this.exp(-2*Math.PI*s/n);return e(),t},DFT:function(){},Matrix:function(t,a,e){var r=[];if(a){if(isNaN(a))var n=/(\d+)\s*\*/.exec(a)[1],i=/\*\s*(\d+)/.exec(a)[1];else n=a,i=e;if(t[0]&&t[0][0])for(o=0;o<n;o++){r[o]=[];for(s=0;s<i;s++)r[o][s]=t[o][s]||0}else for(var o=0;o<n;o++){r[o]=[];for(var s=0;s<i;s++){r[o][s]=t[o*i+s]||0}}this.m=n,this.n=i}else this.m=t.length,this.n=t[0].length;this.data=r},C:function(t,a){this.r=t||0,this.i=a||0},exp:function(t,e){t=t||0,e=e||1;var r=new a.C;return r.r=e*Math.cos(t),r.i=e*Math.sin(t),r},lagrange:function(t,a){function e(a,e){for(var n=1,i=1,o=0;o<r;o++)o!=e&&(n*=t[e]-t[o],i*=a-t[o]);return i/n}var r=t.length;return function(t){for(var n=0,i=0;i<r;i++){var o=e(t,i);n+=a[i]*o}return n}},applyMatrix:function(e,r,n){n=n||0;for(var i=e.data,o=e.width,s=(e.height,r.length),h=new a.Matrix(r,s,1),c=[],u=-(Math.sqrt(s)-1)/2,d=0,f=i.length;d<f;d+=4){var l=d/4,v=parseInt(l/o),g=l%o;if(0!=v&&0!=g){for(var w=[[],[],[]],p=u;p<=-u;p++)for(var m=v+p,y=u;y<=-u;y++)for(var M=4*(m*o+(g+y)),I=0;I<3;I++){var b=M+I;w[I].push(i[b])}for(var x=new t.lib.dorsyMath.Matrix(w,3,s).mutiply(h),I=0;I<3;I++)c[d+I]=x.data[I];c[d+4]=i[d+4]}}for(var d=0,f=i.length;d<f;d++)c[d]&&(i[d]=c[d]<n?c[d]:i[d]);return e},RGBToHSI:function(t,a,e){var r=(t-a+t-e)/2/Math.sqrt((t-a)*(t-a)+(t-e)*(a-e))||0;r=Math.acos(r);var n=e>a?2*Math.PI-r:r;if(t+a+e>0)i=1-3*Math.min(t,a,e)/(t+a+e);else var i=0;var o=(t+a+e)/3;return n>2*Math.PI&&(n=2*Math.PI),n<0&&(n=0),{H:n,S:i,I:o}},HSIToRGB:function(t,a,e){if(t<0?(t%=2*Math.PI,t+=2*Math.PI):t%=2*Math.PI,t<=2*Math.PI/3)var r=e*(1-a),n=e*(1+a*Math.cos(t)/Math.cos(Math.PI/3-t)),i=3*e-(n+r);else if(t<=4*Math.PI/3){t-=2*Math.PI/3;var n=e*(1-a),r=3*e-((i=e*(1+a*Math.cos(t)/Math.cos(Math.PI/3-t)))+n)}else{t-=4*Math.PI/3;n=3*e-((i=e*(1-a))+(r=e*(1+a*Math.cos(t)/Math.cos(Math.PI/3-t))))}return{R:n,G:i,B:r}},applyInHSI:function(t,a){for(var e=["R","Y","G","C","B","M"],r=t.data,n=Math.PI/6,i=Math.PI/3,o=0,s=r.length;o<s;o+=4){var h=this.RGBToHSI(r[o],r[o+1],r[o+2]);a(h,e[~~((h.H+n)/i)%6],r[o+3]),h.S>1&&(h.S=1),h.S<0&&(h.S=0);var c=this.HSIToRGB(h.H,h.S,h.I);r[o]=c.R,r[o+1]=c.G,r[o+2]=c.B}},applyInCoordinate:function(t,a){},distance:function(t,e){return e=e||[0,0],t=new a.C(t[0],t[1]),e=new a.C(e[0],e[1]),t.minus(e).distance()},xyToIFun:function(t){return function(a,e,r){return r=r||0,4*(e*t+a)+r}},xyCal:function(t,a,e,r,n){var i=this.xyToIFun(t.width)(a,e,0),o=t.data,s=r(o[i],o[i+1],o[i+2]);s&&(o[i]=s[0],o[i+1]=s[1],o[i+2]=s[2]),n&&(o[i+3]=n(o[i+3]))}};return a.Matrix.prototype={plus:function(t){if(this.m!=t.m||this.n!=t.n)throw new Error("矩阵加法行列不匹配");for(var e=new a.Matrix([],this.m,this.n),r=0;r<this.m;r++)for(var n=0;n<this.n;n++)e.data[r][n]=this.data[r][n]+t.data[r][n];return e},minus:function(t){if(this.m!=t.m||this.n!=t.n)throw new Error("矩阵减法法行列不匹配");for(var e=new a.Matrix([],this.m,this.n),r=0;r<this.m;r++)for(var n=0;n<this.n;n++)e.data[r][n]=this.data[r][n]-t.data[r][n];return e},mutiply:function(t){if(this.n!=t.m)throw new Error("矩阵乘法行列不匹配");for(var e=new a.Matrix([],this.m,t.n),r=0;r<this.m;r++)for(var n=0;n<t.n;n++){for(var i=0,o=0;o<this.n;o++)i+=this.data[r][o]*t.data[o][n];e.data[r][n]=i}return e}},a.C.prototype={plus:function(t){var e=new a.C;return e.r=this.r+t.r,e.i=this.i+t.i,e},minus:function(t){var e=new a.C;return e.r=this.r-t.r,e.i=this.i-t.i,e},mutiply:function(t){var e=new a.C;return e.r=this.r*t.r-this.i*t.i,e.i=this.r*t.i+this.i*t.r,e},divide:function(t){var e=new a.C,r=t.mutiply(t.conjugated()),n=this.mutiply(t.conjugated());return e.r=n.r/r.r,e.i=n.i/r.r,e},conjugated:function(){return new a.C(this.r,-this.i)},distance:function(){return Math.sqrt(this.r*this.r+this.i*this.i)}},a}),window.psLib.module("dorsyWorker",function(t){var a=200;return function(e){var r=new Worker(t.path);if(!r)throw new Error("使用worker时，alloyimage文件目录指定出错");var n={queue:[],startWorker:function(){this.shiftAction()},shiftAction:function(){function t(){if(n[1].readyState){var i=[e.imgData,n[1].imgData].concat(n.slice(2));r.postMessage(["add",i])}else setTimeout(function(){t()},a)}var n=this.queue.shift(),i=this;if(n){var o=n[0];"act"==o?r.postMessage(["act",n[1],e.imgData,n[2]]):"add"==o?t():"show"==o?(e.show(n[1],n[2],1),this.shiftAction()):"complete"==o?(n[1]&&n[1](),this.shiftAction()):"clone"==o?(e.clone(1),this.shiftAction()):"save"==o?(e.save(0,1),this.shiftAction()):"replace"==o&&(e.replace(n[1],1),this.shiftAction())}else setTimeout(function(){(n=i.queue.shift())||e.notify("readyStateOK")},a)},callback:function(t){e.imgData=t,this.shiftAction()}};return r.onmessage=function(t){n.callback(t.data)},n}}),function(t){window[t].module("easy",function(a){return{getFun:function(a){return{softenFace:function(){return this.clone().add(this.act("高斯模糊",10),"滤色").act("亮度",-10,5)},sketch:function(){var t=this.clone();return this.add(t.act("反色").act("高斯模糊",8),"颜色减淡").act("toGray").act("锐化",1)},softEnhancement:function(){return this.act("曲线",[0,190,255],[0,229,255])},purpleStyle:function(){var t=this.clone();return this.add(t.act("高斯模糊",3),"正片叠底","RG")},soften:function(){var t=this.clone();return this.add(t.act("高斯模糊",6),"变暗")},vintage:function(){this.clone();return this.act("灰度处理").add(window[t](this.canvas.width,this.canvas.height,"#808080").act("添加杂色").act("高斯模糊",4).act("色相/饱和度调节",32,19,0,!0),"叠加")},gray:function(){return this.act("灰度处理")},lomo:function(){return this.clone().add(this.clone(),"滤色").add(this.clone(),"柔光").add(this.clone().act("反色"),"正常","20%","B").act("暗角",6,200)},strongEnhancement:function(){return this.clone().add(this.clone().act("曲线",[0,50,255],[0,234,255]),"柔光")},strongGray:function(){return this.act("灰度处理").act("曲线",[0,61,69,212,255],[0,111,176,237,255])},lightGray:function(){return this.act("灰度处理").act("曲线",[0,60,142,194,255],[0,194,240,247,255])},warmAutumn:function(){var t=this.clone().act("色相/饱和度调节",36,47,8,!0).act("暗角",6,150);return this.add(t,"叠加")},carveStyle:function(){var t=this.clone().act("马赛克").act("查找边缘").act("浮雕效果");return this.add(t,"线性光")},rough:function(){return this.add(window[t](this.canvas.width,this.canvas.height,"#000").act("喷点").act("反色").act("浮雕效果"),"叠加")}}[a]}}})}("psLib"),window.psLib.module("Fix",function(t){function a(t){t.naturalWidth;var a=t.naturalHeight,e=document.createElement("canvas");e.width=1,e.height=a;var r=e.getContext("2d");r.drawImage(t,0,0);for(var n=r.getImageData(0,0,1,a).data,i=0,o=a,s=a;s>i;)0===n[4*(s-1)+3]?o=s:i=s,s=o+i>>1;var h=s/a;return 0===h?1:h}function e(t,e,r,n,i,o,s,h,c,u){var d=a(e);t.drawImage(e,r*d,n*d,i*d,o*d,s,h,c,u)}return{drawImageIOS:function(t,a,r,n){e(t,a,0,0,a.width,a.height,0,0,r,n)},drawImageIOSFix:e}}),window.psLib.module("Tools",function(t){return{getColor:{process:function(a,e){var r,n=t.lib.dorsyMath,i=(n.xyToIFun(a.width),2*Math.PI/50),o=[];n.applyInHSI(a,function(t,a,e){e>128&&(r=parseInt(t.H/i),o[r]||(o[r]=[]),o[r].push([t.S,t.I]))});for(var s=0,h=0,c=0;c<50;c++)o[c]&&o[c].length>s&&(s=o[c].length,h=c);for(var u,d,f=0,l=0,c=0;c<o[h].length;c++)f+=o[h][c][0],l+=o[h][c][1];u=f/o[h].length,d=l/o[h].length;var v=h*i,g=n.HSIToRGB(v,u,d);return"rgb("+parseInt(g.R)+","+parseInt(g.G)+","+parseInt(g.B)+")"}},toText:{process:function(a,e){var r,n=a.data,i=a.width,o=a.height,s=e[0]||".:;!#@",h="";console.log(s);for(var c,u,d=t.lib.dorsyMath.xyToIFun(a.width),f=255/s.length,l=0;l<i;l+=1){for(var v=0;v<o;v+=1)c=d(l,v,0),r=(n[c]+n[c+1]+n[c+2])/3,u=parseInt(r/f),h+=s[u];h+="<br />"}return h}}}}),window.psLib.module("Alteration.brightness",function(t){return{process:function(t,a){for(var e=t.data,r=a[0]/50,n=(a[1]||0)/50,i=Math.tan((45+44*n)*Math.PI/180),o=0,s=e.length;o<s;o+=4)for(var h=0;h<3;h++)e[o+h]=(e[o+h]-127.5*(1-r))*i+127.5*(1+r);return t}}}),window.psLib.module("Alteration.curve",function(t){return{process:function(a,e){var r=t.lib.dorsyMath.lagrange(e[0],e[1]),n=a.data,i=a.width,o=a.height,s=e[2];/[RGB]+/.test(s)||(s="RGB");for(var h=s.replace("R","0").replace("G","1").replace("B","2"),c=[h.indexOf("0")>-1,h.indexOf("1")>-1,h.indexOf("2")>-1],u=0;u<i;u++)for(var d=0;d<o;d++)for(var f=d*i+u,l=0;l<3;l++)c[l]&&(n[4*f+l]=r(n[4*f+l]));return a}}}),window.psLib.module("Alteration.gamma",function(t){return{process:function(a,e){for(var r,n=t.lib.dorsyMath,i=(a.data,a.width),o=a.height,s=((r=void 0==e[0]?10:e[0])+100)/200*2,h=0;h<i;h++)for(var c=0;c<o;c++)n.xyCal(a,h,c,function(t,a,e){return[Math.pow(t,s),Math.pow(a,s),Math.pow(e,s)]});return a}}}),window.psLib.module("Alteration.selectiveColor",function(t){return{process:function(a,e){for(var r=e[0],n=e[1],i=e[2],o=e[3],s=e[4],h=e[5]||0,c={red:"R",green:"G",blue:"B","红色":"R","绿色":"G","蓝色":"B"},u={cyan:"R",magenta:"G",yellow:"B","青色":"R","洋红":"G","黄色":"B"},d=function(t){return c[r]?Math.max(t.R,t.G,t.B)==t[c[r]]:u[r]?Math.min(t.R,t.G,t.B)==t[u[r]]:"black"==r||"黑色"==r?Math.min(t.R,t.G,t.B)<128:"white"==r||"白色"==r?Math.max(t.R,t.G,t.B)>128:"中性色"==r?!(Math.max(t.R,t.G,t.B)<1||Math.min(t.R,t.G,t.B)>224):void 0},f=0,l=[n,i,o,s],v=0,g=a.width;v<g;v++)for(var w=0,p=a.height;w<p;w++)t.lib.dorsyMath.xyCal(a,v,w,function(t,a,e){var n={R:t,G:a,B:e},i=[t,a,e],o=[];if(d(n)){if(c[r]){var v=c[r],g=t+a+e-Math.max(t,a,e)-Math.min(t,a,e);f=n[v]-g}else if(u[r]){var w=u[r],g=t+a+e-Math.max(t,a,e)-Math.min(t,a,e);f=g-n[w]}else if("black"==r||"黑色"==r)f=2*parseInt(127.5-Math.max(t,a,e));else if("white"==r||"白色"==r)f=2*parseInt(Math.min(t,a,e)-127.5);else{if("中性色"!=r)return;f=255-(Math.abs(Math.max(t,a,e)-127.5)+Math.abs(Math.min(t,a,e)-127.5))}for(var p=0;p<3;p++){var m=parseInt(f*(i[p]/255)),y=i[p]-m,M=parseInt(f*(1-i[p]/255)),I=i[p]+M,b=l[p]+s+l[p]*s;if(h){if(i[p]>128&&(m=M),s>0)x=i[p]-s*m;else x=i[p]-s*M;x>I&&(x=I),x<y&&(x=y),M=I-x,m=x-y,s<0&&(m=M),x-=l[p]>0?l[p]*m:l[p]*M}else var x=f*-b+i[p];x>I&&(x=I),x<y&&(x=y),o[p]=x}return o}});return a}}}),window.psLib.module("Alteration.setHSI",function(t){return{process:function(a,e){e[0]=e[0]/180*Math.PI,e[1]=e[1]/100||0,e[2]=e[2]/100*255||0,e[3]=e[3]||!1;var r=e[4];/[RGBCMY]+/.test(r)||(r="RGBCMY");for(var n=r.split(""),i={},o=0;o<n.length;o++)i[n[o]]=1;return t.lib.dorsyMath.applyInHSI(a,function(t,a){i[a]&&(e[3]?(t.H=e[0],t.S=e[1],t.I+=e[2]):(t.H+=e[0],t.S+=e[1],t.I+=e[2]))}),a}}}),window.psLib.module("Filter.ImageEnhance",function(t){return{process:function(t,a,e){arg;for(var r=t.data,n=(t.width,t.height,0),i=r.length;n<i;n+=4);return t.data=r,t}}}),window.psLib.module("Filter.corrode",function(t){return{process:function(t,a){for(var e=parseInt(a[0])||3,r=t.data,n=t.width,i=t.height,o=0;o<n;o++)for(var s=0;s<i;s++)for(var h=s*n+o,c=(s+(parseInt(Math.random()*e*2)-e))*n+o+(parseInt(Math.random()*e*2)-e),u=0;u<3;u++)r[4*h+u]=r[4*c+u];return t}}}),window.psLib.module("Filter.darkCorner",function(t){return{process:function(a,e){for(var r=parseInt(e[0])||3,n=(e[2],e[1]||30),i=a.data,o=a.width,s=a.height,h=2*o/3,c=1*s/2,u=t.lib.dorsyMath.distance([h,c]),d=u*(1-r/10),f=function(t,a,e,r,n){return a*Math.pow(1-t,3)+3*e*t*Math.pow(1-t,2)+3*r*t*t*(1-t)+n*Math.pow(t,3)},l=0;l<o;l++)for(var v=0;v<s;v++)for(var g=v*o+l,w=0;w<3;w++){var p=function(a,e,r){var i=(t.lib.dorsyMath.distance([a,e],[h,c])-d)/(u-d);return i<0&&(i=0),f(i,0,.02,.3,1)*r*n/255}(l,v,i[4*g+w]);i[4*g+w]-=p}return a}}}),window.psLib.module("Filter.dotted",function(t){return{process:function(a,e){for(var r=parseInt(e[0])||1,n=parseInt(e[1])||1,i=a.data,o=a.width,s=a.height,h=2*r+1,c=[],u=n*n,d=-r;d<r;d++)for(v=-r;v<r;v++)d*d+v*v>u&&c.push([d,v]);for(var f=t.lib.dorsyMath.xyToIFun(o),d=0,l=parseInt(o/h);d<l;d++)for(var v=0,g=parseInt(s/h);v<g;v++)for(var w=parseInt((d+.5)*h),p=parseInt((v+.5)*h),m=0;m<c.length;m++){var y=w+c[m][0],M=p+c[m][1];i[f(y,M,3)]=225,i[f(y,M,2)]=225,i[f(y,M,0)]=225,i[f(y,M,1)]=225}return a}}}),window.psLib.module("Filter.embossment",function(t){return{process:function(t,a){for(var e=t.data,r=t.width,n=(t.height,[]),i=0,o=e.length;i<o;i+=4){var s=i/4,h=parseInt(s/r),c=s%r,u=4*((h-1)*r+(c-1)),d=(h+1)*r*4+4*(c+1);if(0!=h&&0!=c){for(var f=0;f<3;f++)n[i+f]=e[u+f]-e[d+f]+127.5;n[i+4]=e[i+4]}}for(var i=0,o=e.length;i<o;i++)e[i]=n[i]||e[i];return t}}}),window.psLib.module("Filter.gaussBlur",function(t){return{process:function(t,a,e){var r,n,i,o,s,h,c,u,d,f,l=t.data,v=t.width,g=t.height,w=[],p=0;for(a=Math.floor(a)||3,e=e||a/3,h=1/(Math.sqrt(2*Math.PI)*e),s=-1/(2*e*e),c=0,r=-a;r<=a;r++,c++)o=h*Math.exp(s*r*r),w[c]=o,p+=o;for(c=0,f=w.length;c<f;c++)w[c]/=p;for(n=0;n<g;n++)for(r=0;r<v;r++){for(i=o=s=h=0,p=0,u=-a;u<=a;u++)(d=r+u)>=0&&d<v&&(c=4*(n*v+d),i+=l[c]*w[u+a],o+=l[c+1]*w[u+a],s+=l[c+2]*w[u+a],p+=w[u+a]);l[c=4*(n*v+r)]=i/p,l[c+1]=o/p,l[c+2]=s/p}for(r=0;r<v;r++)for(n=0;n<g;n++){for(i=o=s=h=0,p=0,u=-a;u<=a;u++)(d=n+u)>=0&&d<g&&(c=4*(d*v+r),i+=l[c]*w[u+a],o+=l[c+1]*w[u+a],s+=l[c+2]*w[u+a],p+=w[u+a]);l[c=4*(n*v+r)]=i/p,l[c+1]=o/p,l[c+2]=s/p}return t.data=l,t}}}),window.psLib.module("Filter.borderline",function(t){return{process:function(a,e){var r=[0,1,0,1,-4,1,0,1,0];return t.lib.dorsyMath.applyMatrix(a,r,250)}}}),window.psLib.module("Filter.mosaic",function(t){return{process:function(t,a){for(var e=parseInt(a[0])||3,r=t.data,n=t.width,i=t.height,o=2*e+1,s=0,h=parseInt(n/o);s<h;s++)for(var c=0,u=parseInt(i/o);c<u;c++){for(var d=[],f=[0,0,0],l=0;l<o;l++)for(g=0;g<o;g++){var v=(c*o+l)*n+s*o+g;f[0]+=r[4*v],f[1]+=r[4*v+1],f[2]+=r[4*v+2]}d[0]=f[0]/(o*o),d[1]=f[1]/(o*o),d[2]=f[2]/(o*o);for(l=0;l<o;l++)for(var g=0;g<o;g++)r[4*(v=(c*o+l)*n+s*o+g)]=d[0],r[4*v+1]=d[1],r[4*v+2]=d[2]}return t}}}),window.psLib.module("Filter.noise",function(t){return{process:function(t,a){for(var e=parseInt(a[0])||100,r=t.data,n=t.width,i=t.height,o=0;o<n;o++)for(var s=0;s<i;s++)for(var h=s*n+o,c=0;c<3;c++){var u=parseInt(Math.random()*e*2)-e;r[4*h+c]+=u}return t}}}),window.psLib.module("Filter.oilPainting",function(t){return{process:function(t,a){for(var e=parseInt(a[0])||16,r=t.data,n=t.width,i=t.height,o=0;o<n;o++)for(var s=0;s<i;s++){for(var h=s*n+o,c=0,u=0;u<3;u++)c+=r[4*h+u];c/=3;for(var d=parseInt(c/e)*e,u=0;u<3;u++)r[4*h+u]=d}return t}}}),window.psLib.module("Filter.posterize",function(t){return{process:function(a,e){var r=t.lib.dorsyMath,n=(a.data,a.width),i=a.height,o=e[0]||20;o=o<1?1:o>255?255:o;for(var s=Math.floor(255/o),h=0;h<n;h++)for(var c=0;c<i;c++)r.xyCal(a,h,c,function(t,a,e){return[Math.floor(t/s)*s,Math.floor(a/s)*s,Math.floor(e/s)*s]});return a}}}),window.psLib.module("Filter.sepia",function(t){return{process:function(a){for(var e=t.lib.dorsyMath,r=(a.data,a.width),n=a.height,i=0;i<r;i++)for(var o=0;o<n;o++)e.xyCal(a,i,o,function(t,a,e){return[.393*t+.769*a+.189*e,.349*t+.686*a+.168*e,.272*t+.534*a+.131*e]});return a}}}),window.psLib.module("Filter.sharp",function(t){return{process:function(t,a){for(var e=a[0]||.6,r=t.data,n=t.width,i=(t.height,0),o=r.length;i<o;i+=4){var s=i/4,h=parseInt(s/n),c=s%n;if(0!=h&&0!=c)for(var u=4*((h-1)*n+(c-1)),d=4*((h-1)*n+c),f=4*(s-1),l=0;l<3;l++){var v=r[i+l]-(r[d+l]+r[f+l]+r[u+l])/3;r[i+l]+=v*e}}return t}}}),window.psLib.module("Filter.toGray",function(t){return{process:function(t){for(var a=t.data,e=0,r=a.length;e<r;e+=4){var n=parseInt(.299*a[e]+.578*a[e+1]+.114*a[e+2]);a[e+2]=a[e+1]=a[e]=n}return t.data=a,t}}}),window.psLib.module("Filter.toReverse",function(t){return{process:function(t){for(var a=t.data,e=0,r=a.length;e<r;e+=4)a[e]=255-a[e],a[e+1]=255-a[e+1],a[e+2]=255-a[e+2];return t.data=a,t}}}),window.psLib.module("Filter.toThresh",function(t){return{process:function(a,e){for(var r=(a=t.reflect("toGray",a)).data,e=e[0]||128,n=0,i=r.length;n<i;n++)(n+1)%4&&(r[n]=r[n]>e?255:0);return a.data=r,a}}});