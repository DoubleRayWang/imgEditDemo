Object.defineProperty(Array.prototype,"del",{set:function(t){},get:function(){return function(t){t.sort(function(t,e){return t-e});for(var e=this.concat([]),r=t.length-1;r>=0;r--)e=e.slice(0,t[r]).concat(e.slice(t[r]+1));return e}},enumerable:!1,configurable:!1});try{HTMLImageElement.prototype.loadOnce=function(t){var e=0;this.onload=function(){e||t.call(this,null),e++}}}catch(t){window={}}(function(t){function e(){this.readyState&&(this.readyState=0,this.dorsyWorker.startWorker())}var r=function(){if(window.navigator){var t=window.navigator.userAgent;return/Android|android/.test(t)?"android":/iPhone|iPad|iPod/.test(t)?"ios":"other"}return"sandBox"}(),a={lib:[],definedPs:{},init:function(){this.require("config")},module:function(t,e){function r(t){var o=a[++n];n!=a.length-1?r(t[o]?t[o]:t[o]={}):t[o]=e.call(null,i)}var a=[t];/\./g.test(t)&&(a=t.split("."));var n=-1,i=this;r(this.lib)},require:function(t){var e=this,r=document.createElement("script");document.body.appendChild(r),r.src="./js/module/"+t+".js",r.onload=r.onerror=function(t){e.handlerror(t)}},handlerror:function(t){},destroySelf:function(e){throw delete window[t],new Error(e)},reflect:function(t,e,r){var a=this.lib.config.getModuleName(t),n=a.spaceName,i=a.actName;switch(n){case"Filter":case"Alteration":return this.lib[n][i].process(e,r);case"ComEffect":return this.lib[i].process(e,r);default:this.destroySelf("AI_ERROR: ")}},reflectEasy:function(t){var e=this.lib.config.getEasyFun(t).actName;return this.definedPs[t]||this.lib.easy.getFun(e)},add:function(t,e,r,a,n,i,o,s){return this.lib.addLayer.add(t,e,r,a,n,i,o,s)},worker:function(t,e){},applyMatrix:function(t,e){},tools:function(t,e){var r=Array.prototype.shift.call(e);if(this.lib.Tools[r])return this.lib.Tools[r].process(t,e);throw new Error("AI_ERROR: 不存在的工具方法_"+r)},definePs:function(t,e){this.definedPs[t]=e}};window[t]=function(e,n,i){var o=this;if(!(this instanceof window[t]))return new window[t](e,n,i);this.startTime=+new Date;var s=document.createElement("canvas"),h=s.getContext("2d");if(isNaN(e))if("string"==typeof e){var c=new Image;c.onload=function(){s.width=parseInt(this.width),s.height=parseInt(this.height),h.drawImage(this,0,0,this.width,this.height)},c.src=e}else{var u=n,f=i,d=e.width,l=e.height,v=d/l;n||i?i?n||(u=f*v):f=~~(u/v):(u=d,f=l),s.width=u,s.height=f,isNaN(u)?h.drawImage(e,0,0):"ios"==r?a.lib.Fix.drawImageIOS(h,e,u,f):h.drawImage(e,0,0,u,f),this.srcImg=e}else s.width=e,s.height=n,i=i||"#fff",h.fillStyle=i,h.fillRect(0,0,e,n),this.srcImg="";this.canvas=s,this.context=h,this.imgData=h.getImageData(0,0,s.width,s.height),this.name=t+"_"+Math.random(),this.canvas.id=this.name,this.layers=[];var p=document.createElement("canvas");if(p.width=s.width,p.height=s.height,this.ctxCanvas=p,this.ctxContext=s.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.useWorker=a.useWorker,this.readyState=1,this.useWorker&&(this.dorsyWorker=a.lib.dorsyWorker(this)),a.lib.Tools)for(var g in a.lib.Tools)this.Tools[g]=function(t){return function(e){return o.Tools(t,e)}}(g)},window[t].module=function(t,e){a.module(t,e)},window[t].dorsyMath=function(){return a.lib.dorsyMath},window[t].setName=function(t){a.name=t||"alloyimage.js"},window[t].getConfig=function(){return a.lib.config.getConfig()},window[t].define=function(t,e){a.definePs(t,e)},window[t].useWorker=function(t){if(!window.Worker)return this.useWorker=0,void console.log("AI_WARNING: 浏览器不支持web worker, 自动切换为单线程\nAI_WARNING: the brower doesn't support Web Worker");var t=t||"";/[\/\\]$/.test(t)&&(t+=a.name),""==t&&(t="alloyimage.js"),a.useWorker=1,a.path=t;var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&"404"==e.status&&a.destroySelf("AI_ERROR：使用worker时，ai文件路径指定错误\nAI_ERROR: error occured while using web worker since indicate the wrong path of file ai")},e.open("GET",t,!1),e.send()},onmessage=function(t){var e,r=t.data;"act"==r[0]?e=a.reflect(r[1],r[2],r[3]):"add"==r[0]&&(e=a.add.apply(a,r[1])),postMessage(e)},window[t].prototype={set width(t){this.canvas.width=t},set height(t){this.canvas.height=t},get width(){return this.canvas.width},get height(){return this.canvas.height},act:function(t,r){var n=[];return n=Array.prototype.slice.call(arguments,1),this.useWorker?(this.dorsyWorker.queue.push(["act",t,n]),e.call(this)):a.reflect(t,this.imgData,n),this},view:function(t,e,r,a,n){if(t){var i=this.layers.length;this.layers[i-1]&&1===this.layers[i-1][0].type&&this.cancel();for(var o,s=this.layers.length-1;s>-1;s--){var h=this.layers[s];if(2===h[0].type){o=h[0].clone();break}}o||(o=this.clone(),window.newLayer=o),"ps"===t?o=o.ps(e,r,a,n):o.act(t,e,r,a,n),o.type=1,this.addLayer(o,"正常",0,0)}else this.cancel();return this},doView:function(){var t=this.layers.length;return this.layers[t-1]&&2===this.layers[t-1][0].type?this:(this.layers[t-1]&&1===this.layers[t-1][0].type&&(this.layers[t-1][0].type=2),this)},undoView:function(){this.cancel();for(var t=this.layers.length-1;t>-1;t--){var e=this.layers[t];if(2===e[0].type){e[0].type=1;break}}return this},excute:function(){var t=this.layers,e=t.length;return t[e-1]&&1==t[e-1][0].type&&(this.imgData=t[e-1][0].imgData,delete t[e-1]),this},cancel:function(){var t=this.layers,e=t.length;return t[e-1]&&1==t[e-1][0].type&&t.pop(),this},complileLayers:function(e){if(0==this.layers.length)this.tempPsLib={imgData:this.imgData};else{var r=new window[t](this.canvas.width,this.canvas.height);r.add(this,"正常",0,0,e),this.tempPsLib=r;for(var a=0;a<this.layers.length;a++){var n=this.layers[a],i=n[0].layers,o=n[0];i[i.length-1]&&1==i[i.length-1][0].type&&(o=i[i.length-1][0]),r.add(o,n[1],n[2],n[3],e)}}},show:function(t,e,r){return!r&&this.useWorker?(this.dorsyWorker.queue.push(["show",t,e]),this):(this.complileLayers(e),this.context.putImageData(this.tempPsLib.imgData,0,0),t?"string"==typeof t?document.querySelector(t).appendChild(this.canvas):t.appendChild(this.canvas):document.body.appendChild(this.canvas),this)},replaceChild:function(t){var e;return e="string"==typeof t?document.querySelector(t):t,e.innerHTML="",this.show(e)},replace:function(t,r){return!r&&this.useWorker?(this.dorsyWorker.queue.push(["replace",t]),e.call(this),this):(t&&(t.onload=function(){},t.src=this.save(0,1,r)),this)},add:function(){for(var t,r,n,i,o,s,h,c=[],u=0;u<arguments.length;u++)if(u)switch(typeof arguments[u]){case"string":/\d+%/.test(arguments[u])?n=arguments[u].replace("%",""):/[RGB]+/.test(arguments[u])?h=arguments[u]:r=arguments[u];break;case"number":c.push(arguments[u]);break;case"boolean":s=arguments[u]}return i=c[0]||0,o=c[1]||0,r=r||"正常",n=n/100||1,s=s||!1,h=h||"RGB",t=arguments[0],this.useWorker?(this.dorsyWorker.queue.push(["add",t,r,n,i,o,s,h]),e.call(this)):a.add(this.imgData,t.imgData,r,n,i,o,s,h),this},addLayer:function(t,e,r,a){return this.layers.push([t,e,r,a]),this},clone:function(e){var r=new window[t](this.canvas.width,this.canvas.height);return r.context.putImageData(this.imgData,0,0),r.imgData=r.context.getImageData(0,0,this.canvas.width,this.canvas.height),r},swap:function(t,e){var r=this.layers[t];return this.layers[t]=this.layers[e],this.layers[e]=r,this},deleteLayers:function(t){this.layers=this.layers.del(t)},save:function(t,r,a){t=(t=t||"png").toLowerCase(),r=r||.8,"jpg"==t&&(t="jpeg");var n="image/"+t;return!a&&this.useWorker?(this.dorsyWorker.queue.push(["save"]),e.call(this),this):(this.complileLayers(),this.context.putImageData(this.tempPsLib.imgData,0,0),this.canvas.toDataURL(n,r))},saveFile:function(t,e){t=t||"AlloyImage合成图像.jpg",e=e||1;var r=/.*.(jpg|png|gif|jpeg)$/g,a="png";r.test(t)?(r.lastIndex=0,a=r.exec(t)[1]):t+=".png";var n=this.save(a,e),i=document.createElement("a");i.href=n,i.download=t;var o=document.createEvent("HTMLEvents");o.initEvent("click",!1,!1),i.dispatchEvent(o)},download:function(t,e){this.saveFile(t,e)},saveAsDataURL:function(){},saveAsBlob:function(){},saveAsBuffer:function(){},drawRect:function(t,e){var r;e||(e="RGB");var a=(e||"").replace("R","0").replace("G","1").replace("B","2"),n=[a.indexOf("0")>-1,a.indexOf("1")>-1,a.indexOf("2")>-1];(r=document.getElementById("imgRect"))||(r=document.createElement("canvas"),r.id="imgRect",document.body.appendChild(r),r.width=parseInt(this.canvas.width),r.height=parseInt(this.canvas.height));var i=r.getContext("2d");i.clearRect(0,0,r.width,r.height);var o=[[],[],[]];this.complileLayers();var s=this.tempPsLib.imgData.data,h=this.tempPsLib.imgData.width,c=this.tempPsLib.imgData.height;if(a)for(var u=0;u<c;u++)for(var f=0;f<h;f++)for(var d=4*(v=u*h+f),l=0;l<3;l++)n[l]&&(o[l][s[d+l]]?o[l][s[d+l]]++:o[l][s[d+l]]=1);else for(var v=0,p=s.length;v<p;v++)o[s[v]]?o[s[v]]++:o[s[v]]=1;var g=function(t,e){i.beginPath(),i.moveTo(0,r.height);for(var a=0,n=0;n<255;n++)t[n]>a&&(a=t[n]);for(n=0;n<255;n++){var o=t[n]||0;o=r.height-o/a*.8*r.height,i.lineTo(n/256*r.width,o)}i.lineTo(r.width+10,r.height),i.closePath(),i.fillStyle=e,i.fill()};if(a)for(var w=["red","green","blue"],v=0;v<o.length;v++)o[v].length&&g(o[v],w[v]);else g(o,"black")},ps:function(t){return"原图"==t||"origin"==t||""==t?this:a.reflectEasy(t).call(this,this.canvas)},logTime:function(t){},ctx:function(t){var e=this.ctxContext;return e.putImageData(this.imgData,0,0),t.call(e),this.imgData=e.getImageData(0,0,this.canvas.width,this.canvas.height),this},notify:function(t){"readyStateOK"==t&&(this.readyState=1)},complete:function(t){this.useWorker?this.dorsyWorker.queue.push(["complete",t]):t()},transform:function(e,r,a){var n=window[t].dorsyMath(),i=this.ctxContext;i.putImageData(this.imgData,0,0);for(var o=document.createElement("canvas").getContext("2d"),s=[new n.Matrix([0,0],"1*2"),new n.Matrix([0,this.canvas.height],"1*2"),new n.Matrix([this.canvas.width,0],"1 * 2"),new n.Matrix([this.canvas.width,this.canvas.height],"1*2")],h=[],c=new n.Matrix(e,"2*2"),u=0;u<s.length;u++)h.push(s[u].mutiply(c));var f=Math.max(h[0].data[0][0],h[1].data[0][0],h[2].data[0][0],h[3].data[0][0]),d=Math.min(h[0].data[0][0],h[1].data[0][0],h[2].data[0][0],h[3].data[0][0]),l=Math.max(h[0].data[0][1],h[1].data[0][1],h[2].data[0][1],h[3].data[0][1]),v=Math.min(h[0].data[0][1],h[1].data[0][1],h[2].data[0][1],h[3].data[0][1]),p=~~(f-d),g=~~(l-v);o.canvas.width=p,o.canvas.height=g,o.translate(-d,-v),o.transform.apply(o,e),o.drawImage(i.canvas,0,0),this.canvas.width=p,this.canvas.height=g,this.width=p,this.height=g,this.imgData=o.getImageData(0,0,p,g);for(u=this.layers.length-1;u>-1;u--){var w=this.layers[u];(2===w[0].type||1===w[0].type)&&w[0].transform(e,r,a)}return this},scale:function(t,e){var e=e||t;return this.transform([t,0,0,e,0,0])},scaleTo:function(t,e){var r,a,n=this.width,i=this.height;if(e||(e=t*i/n),t||(t=e*(n/i)),t&&e)return r=t/n,a=e/i,this.scale(r,a)},rotate:function(t){var e=t/180*Math.PI,r=[Math.cos(e),Math.sin(e),-Math.sin(e),Math.cos(e),0,0];return this.transform(r)},moveTo:function(t,e){return t=t||0,e=e||0,this.transform([1,0,0,1,t,e])},clip:function(t,e,r,a){return this.ctxContext.putImageData(this.imgData,0,0),this.imgData=this.ctxContext.getImageData(t,e,r,a),this.context.canvas.width=r,this.context.canvas.height=a,this},Tools:function(t){return a.tools(this.imgData,arguments)}}})("psLib"),window.AlloyImage=window.$AI=window.psLib,window.psLib.module("addLayer",function(t){return{add:function(t,e,r,a,n,i,o,s){var h=t.data,c=e.data,n=n||0,i=i||0,a=a||1,s=s||"RGB";/[RGB]+/.test(s)||(s="RGB");var u,f=s.replace("R","0").replace("G","1").replace("B","2"),d=t.width,l=t.height,v=(c.length,e.width),p=e.height,g=[f.indexOf("0")>-1,f.indexOf("1")>-1,f.indexOf("2")>-1],w=n,m=n+v,y=i,M=i+p;if(!(w>d||(w<0&&(w=0),m<0||(m>d&&(m=d),y>l||(y<0&&(y=0),M<0))))){M>l&&(M=l);for(var I,b,x=y;x<M;x++){I=x*d,b=(x-i)*v;for(var k=w;k<m;k++)for(var R=4*(I+k),L=4*(b+(k-n)),C=0;C<3&&0!=c[L+3];C++)switch(h[R+3]=c[L+3],r){case"颜色减淡":g[C]&&(u=h[R+C]+h[R+C]*c[L+C]/(255-c[L+C]),h[R+C]=(1-a)*h[R+C]+a*u);break;case"变暗":g[C]&&(u=h[R+C]<c[L+C]?h[R+C]:c[L+C],h[R+C]=(1-a)*h[R+C]+a*u);break;case"变亮":g[C]&&(u=h[R+C]>c[L+C]?h[R+C]:c[L+C],h[R+C]=(1-a)*h[R+C]+a*u);break;case"正片叠底":g[C]&&(u=~~(h[R+C]*c[L+C]/255),h[R+C]=(1-a)*h[R+C]+a*u);break;case"滤色":g[C]&&(u=~~(255-(255-h[R+C])*(255-c[L+C])/255),h[R+C]=(1-a)*h[R+C]+a*u);break;case"叠加":g[C]&&(u=h[R+C]<=127.5?h[R+C]*c[L+C]/127.5:255-(255-h[R+C])*(255-c[L+C])/127.5,h[R+C]=(1-a)*h[R+C]+a*u);break;case"强光":g[C]&&(u=c[L+C]<=127.5?h[R+C]*c[L+C]/127.5:h[R+C]+(255-h[R+C])*(c[L+C]-127.5)/127.5,h[R+C]=(1-a)*h[R+C]+a*u);break;case"差值":g[C]&&(u=h[R+C]>c[L+C]?h[R+C]-c[L+C]:c[L+C]-h[R+C],h[R+C]=(1-a)*h[R+C]+a*u);break;case"排除":g[C]&&(u=h[R+C]+c[L+C]-h[R+C]*c[L+C]/127.5,h[R+C]=(1-a)*h[R+C]+a*u);break;case"点光":g[C]&&(u=h[R+C]<2*c[L+C]-255?2*c[L+C]-255:h[R+C]<2*c[L+C]?h[R+C]:2*c[L+C],h[R+C]=(1-a)*h[R+C]+a*u);break;case"颜色加深":g[C]&&(u=255-255*(255-h[R+C])/c[L+C],h[R+C]=(1-a)*h[R+C]+a*u);break;case"线性加深":g[C]&&(u=(G=h[R+C]+c[L+C])>255?G-255:0,h[R+C]=(1-a)*h[R+C]+a*u);break;case"线性减淡":g[C]&&(u=(G=h[R+C]+c[L+C])>255?255:G,h[R+C]=(1-a)*h[R+C]+a*u);break;case"柔光":g[C]&&(u=c[L+C]<127.5?((2*c[L+C]-255)*(255-h[R+C])/65025+1)*h[R+C]:(2*c[L+C]-255)*(Math.sqrt(h[R+C]/255)-h[R+C]/255)+h[R+C],h[R+C]=(1-a)*h[R+C]+a*u);break;case"亮光":g[C]&&(u=c[L+C]<127.5?255*(1-(255-h[R+C])/(2*c[L+C])):h[R+C]/(2*(1-c[L+C]/255)),h[R+C]=(1-a)*h[R+C]+a*u);break;case"线性光":if(g[C]){var G=h[R+C]+2*c[L+C]-255;u=G>255?255:G,h[R+C]=(1-a)*h[R+C]+a*u}break;case"实色混合":g[C]&&(u=c[L+C]<255-h[R+C]?0:255,h[R+C]=(1-a)*h[R+C]+a*u);break;default:g[C]&&(u=c[L+C],h[R+C]=(1-a)*h[R+C]+a*u)}}return t}}}}),window.psLib.module("applyMatrix",function(t){return{process:function(e,r){for(var a=e.data,n=e.width,i=(e.height,new t.lib.dorsyMath.Matrix([-2,-4,-4,-4,-2,-4,0,8,0,-4,-4,8,24,8,-4,-4,0,8,0,-4,-2,-4,-4,-4,-2],25,1)),o=[],s=0,h=a.length;s<h;s+=4){var c=s/4,u=parseInt(c/n),f=c%n;if(0!=u&&0!=f){for(var d=[[],[],[]],l=-2;l<3;l++)for(var v=u+l,p=-2;p<3;p++)for(var g=4*(v*n+(f+p)),w=0;w<3;w++){var m=g+w;d[w].push(a[m])}for(var y=new t.lib.dorsyMath.Matrix(d,3,matrixSize).mutiply(i),w=0;w<3;w++)o[s+w]=y.data[w];o[s+4]=a[s+4]}}for(var s=0,h=a.length;s<h;s++)a[s]=o[s]||a[s];return e}}}),window.psLib.module("config",function(t){var e={Alteration:{"亮度":"brightness","色相/饱和度调节":"setHSI","曲线":"curve","gamma调节":"gamma","可选颜色":"selectiveColor"},Filter:{"灰度处理":"toGray","反色":"toReverse","灰度阈值":"toThresh","高斯模糊":"gaussBlur","浮雕效果":"embossment","查找边缘":"borderline","马赛克":"mosaic","油画":"oilPainting","腐蚀":"corrode","锐化":"sharp","添加杂色":"noise","暗角":"darkCorner","喷点":"dotted","降噪":"denoise","棕褐色":"sepia","色调分离":"posterize"},ComEffect:{"美肤":"softenFace","素描":"sketch","自然增强":"softEnhancement","紫调":"purpleStyle","柔焦":"soften","复古":"vintage","黑白":"gray","仿lomo":"lomo","亮白增强":"strongEnhancement","灰白":"strongGray","灰色":"lightGray","暖秋":"warmAutumn","木雕":"carveStyle","粗糙":"rough"}},r=function(){var t={};for(var r in e)if("ComEffect"!=r)for(var a in e[r])t[a]=r,t[e[r][a]]=r;return t}();return{getModuleName:function(t){var a;if(a=r[t])return{spaceName:a,actName:e[a][t]||t};throw new Error("AI_ERROR:调用AI不存在的方法"+t)},getEasyFun:function(t){return{spaceName:"ComEffect",actName:e.ComEffect[t]||t}},getConfig:function(){return e}}}),window.psLib.module("dorsyMath",function(t){var e={FFT1:function(t){function r(){i++;for(var t=n/Math.pow(2,i),e=n/t,o=0;o<t;o++)a(o*e,(o+1)*e-1,i);t>1&&r()}function a(r,a,i){for(var s=Math.pow(2,i-1),h=r,c=0;h<=a-s;h++){var u=h+s,f=c*n/Math.pow(2,i),d=f+n/4;t[h]instanceof e.C||(t[h]=new e.C(t[h])),t[u]instanceof e.C||(t[u]=new e.C(t[u]));var l=t[h].plus(t[u].mutiply(o[f])),v=t[h].plus(t[u].mutiply(o[d]));t[h]=l,t[u]=v,c++}}for(var n=t.length,i=0,o=[],s=0;s<n;s++)o[s]=this.exp(-2*Math.PI*s/n);return r(),t},DFT:function(){},Matrix:function(t,e,r){var a=[];if(e){if(isNaN(e))var n=/(\d+)\s*\*/.exec(e)[1],i=/\*\s*(\d+)/.exec(e)[1];else n=e,i=r;if(t[0]&&t[0][0])for(o=0;o<n;o++){a[o]=[];for(s=0;s<i;s++)a[o][s]=t[o][s]||0}else for(var o=0;o<n;o++){a[o]=[];for(var s=0;s<i;s++){a[o][s]=t[o*i+s]||0}}this.m=n,this.n=i}else this.m=t.length,this.n=t[0].length;this.data=a},C:function(t,e){this.r=t||0,this.i=e||0},exp:function(t,r){t=t||0,r=r||1;var a=new e.C;return a.r=r*Math.cos(t),a.i=r*Math.sin(t),a},lagrange:function(t,e){function r(e,r){for(var n=1,i=1,o=0;o<a;o++)o!=r&&(n*=t[r]-t[o],i*=e-t[o]);return i/n}var a=t.length;return function(t){for(var n=0,i=0;i<a;i++){var o=r(t,i);n+=e[i]*o}return n}},applyMatrix:function(r,a,n){n=n||0;for(var i=r.data,o=r.width,s=(r.height,a.length),h=new e.Matrix(a,s,1),c=[],u=-(Math.sqrt(s)-1)/2,f=0,d=i.length;f<d;f+=4){var l=f/4,v=parseInt(l/o),p=l%o;if(0!=v&&0!=p){for(var g=[[],[],[]],w=u;w<=-u;w++)for(var m=v+w,y=u;y<=-u;y++)for(var M=4*(m*o+(p+y)),I=0;I<3;I++){var b=M+I;g[I].push(i[b])}for(var x=new t.lib.dorsyMath.Matrix(g,3,s).mutiply(h),I=0;I<3;I++)c[f+I]=x.data[I];c[f+4]=i[f+4]}}for(var f=0,d=i.length;f<d;f++)c[f]&&(i[f]=c[f]<n?c[f]:i[f]);return r},RGBToHSI:function(t,e,r){var a=(t-e+t-r)/2/Math.sqrt((t-e)*(t-e)+(t-r)*(e-r))||0;a=Math.acos(a);var n=r>e?2*Math.PI-a:a;if(t+e+r>0)i=1-3*Math.min(t,e,r)/(t+e+r);else var i=0;var o=(t+e+r)/3;return n>2*Math.PI&&(n=2*Math.PI),n<0&&(n=0),{H:n,S:i,I:o}},HSIToRGB:function(t,e,r){if(t<0?(t%=2*Math.PI,t+=2*Math.PI):t%=2*Math.PI,t<=2*Math.PI/3)var a=r*(1-e),n=r*(1+e*Math.cos(t)/Math.cos(Math.PI/3-t)),i=3*r-(n+a);else if(t<=4*Math.PI/3){t-=2*Math.PI/3;var n=r*(1-e),a=3*r-((i=r*(1+e*Math.cos(t)/Math.cos(Math.PI/3-t)))+n)}else{t-=4*Math.PI/3;n=3*r-((i=r*(1-e))+(a=r*(1+e*Math.cos(t)/Math.cos(Math.PI/3-t))))}return{R:n,G:i,B:a}},applyInHSI:function(t,e){for(var r=["R","Y","G","C","B","M"],a=t.data,n=Math.PI/6,i=Math.PI/3,o=0,s=a.length;o<s;o+=4){var h=this.RGBToHSI(a[o],a[o+1],a[o+2]);e(h,r[~~((h.H+n)/i)%6],a[o+3]),h.S>1&&(h.S=1),h.S<0&&(h.S=0);var c=this.HSIToRGB(h.H,h.S,h.I);a[o]=c.R,a[o+1]=c.G,a[o+2]=c.B}},applyInCoordinate:function(t,e){},distance:function(t,r){return r=r||[0,0],t=new e.C(t[0],t[1]),r=new e.C(r[0],r[1]),t.minus(r).distance()},xyToIFun:function(t){return function(e,r,a){return a=a||0,4*(r*t+e)+a}},xyCal:function(t,e,r,a,n){var i=this.xyToIFun(t.width)(e,r,0),o=t.data,s=a(o[i],o[i+1],o[i+2]);s&&(o[i]=s[0],o[i+1]=s[1],o[i+2]=s[2]),n&&(o[i+3]=n(o[i+3]))}};return e.Matrix.prototype={plus:function(t){if(this.m!=t.m||this.n!=t.n)throw new Error("矩阵加法行列不匹配");for(var r=new e.Matrix([],this.m,this.n),a=0;a<this.m;a++)for(var n=0;n<this.n;n++)r.data[a][n]=this.data[a][n]+t.data[a][n];return r},minus:function(t){if(this.m!=t.m||this.n!=t.n)throw new Error("矩阵减法法行列不匹配");for(var r=new e.Matrix([],this.m,this.n),a=0;a<this.m;a++)for(var n=0;n<this.n;n++)r.data[a][n]=this.data[a][n]-t.data[a][n];return r},mutiply:function(t){if(this.n!=t.m)throw new Error("矩阵乘法行列不匹配");for(var r=new e.Matrix([],this.m,t.n),a=0;a<this.m;a++)for(var n=0;n<t.n;n++){for(var i=0,o=0;o<this.n;o++)i+=this.data[a][o]*t.data[o][n];r.data[a][n]=i}return r}},e.C.prototype={plus:function(t){var r=new e.C;return r.r=this.r+t.r,r.i=this.i+t.i,r},minus:function(t){var r=new e.C;return r.r=this.r-t.r,r.i=this.i-t.i,r},mutiply:function(t){var r=new e.C;return r.r=this.r*t.r-this.i*t.i,r.i=this.r*t.i+this.i*t.r,r},divide:function(t){var r=new e.C,a=t.mutiply(t.conjugated()),n=this.mutiply(t.conjugated());return r.r=n.r/a.r,r.i=n.i/a.r,r},conjugated:function(){return new e.C(this.r,-this.i)},distance:function(){return Math.sqrt(this.r*this.r+this.i*this.i)}},e}),window.psLib.module("dorsyWorker",function(t){var e=200;return function(r){var a=new Worker(t.path);if(!a)throw new Error("使用worker时，alloyimage文件目录指定出错");var n={queue:[],startWorker:function(){this.shiftAction()},shiftAction:function(){function t(){if(n[1].readyState){var i=[r.imgData,n[1].imgData].concat(n.slice(2));a.postMessage(["add",i])}else setTimeout(function(){t()},e)}var n=this.queue.shift(),i=this;if(n){var o=n[0];"act"==o?a.postMessage(["act",n[1],r.imgData,n[2]]):"add"==o?t():"show"==o?(r.show(n[1],n[2],1),this.shiftAction()):"complete"==o?(n[1]&&n[1](),this.shiftAction()):"clone"==o?(r.clone(1),this.shiftAction()):"save"==o?(r.save(0,1),this.shiftAction()):"replace"==o&&(r.replace(n[1],1),this.shiftAction())}else setTimeout(function(){(n=i.queue.shift())||r.notify("readyStateOK")},e)},callback:function(t){r.imgData=t,this.shiftAction()}};return a.onmessage=function(t){n.callback(t.data)},n}}),function(t){window[t].module("easy",function(e){return{getFun:function(e){return{softenFace:function(){return this.clone().add(this.act("高斯模糊",10),"滤色").act("亮度",-10,5)},sketch:function(){var t=this.clone();return this.add(t.act("反色").act("高斯模糊",8),"颜色减淡").act("toGray").act("锐化",1)},softEnhancement:function(){return this.act("曲线",[0,190,255],[0,229,255])},purpleStyle:function(){var t=this.clone();return this.add(t.act("高斯模糊",3),"正片叠底","RG")},soften:function(){var t=this.clone();return this.add(t.act("高斯模糊",6),"变暗")},vintage:function(){this.clone();return this.act("灰度处理").add(window[t](this.canvas.width,this.canvas.height,"#808080").act("添加杂色").act("高斯模糊",4).act("色相/饱和度调节",32,19,0,!0),"叠加")},gray:function(){return this.act("灰度处理")},lomo:function(){return this.clone().add(this.clone(),"滤色").add(this.clone(),"柔光").add(this.clone().act("反色"),"正常","20%","B").act("暗角",6,200)},strongEnhancement:function(){return this.clone().add(this.clone().act("曲线",[0,50,255],[0,234,255]),"柔光")},strongGray:function(){return this.act("灰度处理").act("曲线",[0,61,69,212,255],[0,111,176,237,255])},lightGray:function(){return this.act("灰度处理").act("曲线",[0,60,142,194,255],[0,194,240,247,255])},warmAutumn:function(){var t=this.clone().act("色相/饱和度调节",36,47,8,!0).act("暗角",6,150);return this.add(t,"叠加")},carveStyle:function(){var t=this.clone().act("马赛克").act("查找边缘").act("浮雕效果");return this.add(t,"线性光")},rough:function(){return this.add(window[t](this.canvas.width,this.canvas.height,"#000").act("喷点").act("反色").act("浮雕效果"),"叠加")}}[e]}}})}("psLib"),window.psLib.module("Fix",function(t){function e(t){t.naturalWidth;var e=t.naturalHeight,r=document.createElement("canvas");r.width=1,r.height=e;var a=r.getContext("2d");a.drawImage(t,0,0);for(var n=a.getImageData(0,0,1,e).data,i=0,o=e,s=e;s>i;)0===n[4*(s-1)+3]?o=s:i=s,s=o+i>>1;var h=s/e;return 0===h?1:h}function r(t,r,a,n,i,o,s,h,c,u){var f=e(r);t.drawImage(r,a*f,n*f,i*f,o*f,s,h,c,u)}return{drawImageIOS:function(t,e,a,n){r(t,e,0,0,e.width,e.height,0,0,a,n)},drawImageIOSFix:r}}),window.psLib.module("Tools",function(t){return{getColor:{process:function(e,r){var a,n=t.lib.dorsyMath,i=(n.xyToIFun(e.width),2*Math.PI/50),o=[];n.applyInHSI(e,function(t,e,r){r>128&&(a=parseInt(t.H/i),o[a]||(o[a]=[]),o[a].push([t.S,t.I]))});for(var s=0,h=0,c=0;c<50;c++)o[c]&&o[c].length>s&&(s=o[c].length,h=c);for(var u,f,d=0,l=0,c=0;c<o[h].length;c++)d+=o[h][c][0],l+=o[h][c][1];u=d/o[h].length,f=l/o[h].length;var v=h*i,p=n.HSIToRGB(v,u,f);return"rgb("+parseInt(p.R)+","+parseInt(p.G)+","+parseInt(p.B)+")"}},toText:{process:function(e,r){var a,n=e.data,i=e.width,o=e.height,s=r[0]||".:;!#@",h="";console.log(s);for(var c,u,f=t.lib.dorsyMath.xyToIFun(e.width),d=255/s.length,l=0;l<i;l+=1){for(var v=0;v<o;v+=1)c=f(l,v,0),a=(n[c]+n[c+1]+n[c+2])/3,u=parseInt(a/d),h+=s[u];h+="<br />"}return h}}}}),window.psLib.module("Alteration.brightness",function(t){return{process:function(t,e){for(var r=t.data,a=e[0]/50,n=(e[1]||0)/50,i=Math.tan((45+44*n)*Math.PI/180),o=0,s=r.length;o<s;o+=4)for(var h=0;h<3;h++)r[o+h]=(r[o+h]-127.5*(1-a))*i+127.5*(1+a);return t}}}),window.psLib.module("Alteration.curve",function(t){return{process:function(e,r){var a=t.lib.dorsyMath.lagrange(r[0],r[1]),n=e.data,i=e.width,o=e.height,s=r[2];/[RGB]+/.test(s)||(s="RGB");for(var h=s.replace("R","0").replace("G","1").replace("B","2"),c=[h.indexOf("0")>-1,h.indexOf("1")>-1,h.indexOf("2")>-1],u=0;u<i;u++)for(var f=0;f<o;f++)for(var d=f*i+u,l=0;l<3;l++)c[l]&&(n[4*d+l]=a(n[4*d+l]));return e}}}),window.psLib.module("Alteration.gamma",function(t){return{process:function(e,r){for(var a,n=t.lib.dorsyMath,i=(e.data,e.width),o=e.height,s=((a=void 0==r[0]?10:r[0])+100)/200*2,h=0;h<i;h++)for(var c=0;c<o;c++)n.xyCal(e,h,c,function(t,e,r){return[Math.pow(t,s),Math.pow(e,s),Math.pow(r,s)]});return e}}}),window.psLib.module("Alteration.selectiveColor",function(t){return{process:function(e,r){for(var a=r[0],n=r[1],i=r[2],o=r[3],s=r[4],h=r[5]||0,c={red:"R",green:"G",blue:"B","红色":"R","绿色":"G","蓝色":"B"},u={cyan:"R",magenta:"G",yellow:"B","青色":"R","洋红":"G","黄色":"B"},f=function(t){return c[a]?Math.max(t.R,t.G,t.B)==t[c[a]]:u[a]?Math.min(t.R,t.G,t.B)==t[u[a]]:"black"==a||"黑色"==a?Math.min(t.R,t.G,t.B)<128:"white"==a||"白色"==a?Math.max(t.R,t.G,t.B)>128:"中性色"==a?!(Math.max(t.R,t.G,t.B)<1||Math.min(t.R,t.G,t.B)>224):void 0},d=0,l=[n,i,o,s],v=0,p=e.width;v<p;v++)for(var g=0,w=e.height;g<w;g++)t.lib.dorsyMath.xyCal(e,v,g,function(t,e,r){var n={R:t,G:e,B:r},i=[t,e,r],o=[];if(f(n)){if(c[a]){var v=c[a],p=t+e+r-Math.max(t,e,r)-Math.min(t,e,r);d=n[v]-p}else if(u[a]){var g=u[a],p=t+e+r-Math.max(t,e,r)-Math.min(t,e,r);d=p-n[g]}else if("black"==a||"黑色"==a)d=2*parseInt(127.5-Math.max(t,e,r));else if("white"==a||"白色"==a)d=2*parseInt(Math.min(t,e,r)-127.5);else{if("中性色"!=a)return;d=255-(Math.abs(Math.max(t,e,r)-127.5)+Math.abs(Math.min(t,e,r)-127.5))}for(var w=0;w<3;w++){var m=parseInt(d*(i[w]/255)),y=i[w]-m,M=parseInt(d*(1-i[w]/255)),I=i[w]+M,b=l[w]+s+l[w]*s;if(h){if(i[w]>128&&(m=M),s>0)x=i[w]-s*m;else x=i[w]-s*M;x>I&&(x=I),x<y&&(x=y),M=I-x,m=x-y,s<0&&(m=M),x-=l[w]>0?l[w]*m:l[w]*M}else var x=d*-b+i[w];x>I&&(x=I),x<y&&(x=y),o[w]=x}return o}});return e}}}),window.psLib.module("Alteration.setHSI",function(t){return{process:function(e,r){r[0]=r[0]/180*Math.PI,r[1]=r[1]/100||0,r[2]=r[2]/100*255||0,r[3]=r[3]||!1;var a=r[4];/[RGBCMY]+/.test(a)||(a="RGBCMY");for(var n=a.split(""),i={},o=0;o<n.length;o++)i[n[o]]=1;return t.lib.dorsyMath.applyInHSI(e,function(t,e){i[e]&&(r[3]?(t.H=r[0],t.S=r[1],t.I+=r[2]):(t.H+=r[0],t.S+=r[1],t.I+=r[2]))}),e}}}),window.psLib.module("Filter.corrode",function(t){return{process:function(t,e){for(var r=parseInt(e[0])||3,a=t.data,n=t.width,i=t.height,o=0;o<n;o++)for(var s=0;s<i;s++)for(var h=s*n+o,c=(s+(parseInt(Math.random()*r*2)-r))*n+o+(parseInt(Math.random()*r*2)-r),u=0;u<3;u++)a[4*h+u]=a[4*c+u];return t}}}),window.psLib.module("Filter.darkCorner",function(t){return{process:function(e,r){for(var a=parseInt(r[0])||3,n=(r[2],r[1]||30),i=e.data,o=e.width,s=e.height,h=2*o/3,c=1*s/2,u=t.lib.dorsyMath.distance([h,c]),f=u*(1-a/10),d=function(t,e,r,a,n){return e*Math.pow(1-t,3)+3*r*t*Math.pow(1-t,2)+3*a*t*t*(1-t)+n*Math.pow(t,3)},l=0;l<o;l++)for(var v=0;v<s;v++)for(var p=v*o+l,g=0;g<3;g++){var w=function(e,r,a){var i=(t.lib.dorsyMath.distance([e,r],[h,c])-f)/(u-f);return i<0&&(i=0),d(i,0,.02,.3,1)*a*n/255}(l,v,i[4*p+g]);i[4*p+g]-=w}return e}}}),window.psLib.module("Filter.dotted",function(t){return{process:function(e,r){for(var a=parseInt(r[0])||1,n=parseInt(r[1])||1,i=e.data,o=e.width,s=e.height,h=2*a+1,c=[],u=n*n,f=-a;f<a;f++)for(v=-a;v<a;v++)f*f+v*v>u&&c.push([f,v]);for(var d=t.lib.dorsyMath.xyToIFun(o),f=0,l=parseInt(o/h);f<l;f++)for(var v=0,p=parseInt(s/h);v<p;v++)for(var g=parseInt((f+.5)*h),w=parseInt((v+.5)*h),m=0;m<c.length;m++){var y=g+c[m][0],M=w+c[m][1];i[d(y,M,3)]=225,i[d(y,M,2)]=225,i[d(y,M,0)]=225,i[d(y,M,1)]=225}return e}}}),window.psLib.module("Filter.embossment",function(t){return{process:function(t,e){for(var r=t.data,a=t.width,n=(t.height,[]),i=0,o=r.length;i<o;i+=4){var s=i/4,h=parseInt(s/a),c=s%a,u=4*((h-1)*a+(c-1)),f=(h+1)*a*4+4*(c+1);if(0!=h&&0!=c){for(var d=0;d<3;d++)n[i+d]=r[u+d]-r[f+d]+127.5;n[i+4]=r[i+4]}}for(var i=0,o=r.length;i<o;i++)r[i]=n[i]||r[i];return t}}}),window.psLib.module("Filter.gaussBlur",function(t){return{process:function(t,e,r){var a,n,i,o,s,h,c,u,f,d,l=t.data,v=t.width,p=t.height,g=[],w=0;for(e=Math.floor(e)||3,r=r||e/3,h=1/(Math.sqrt(2*Math.PI)*r),s=-1/(2*r*r),c=0,a=-e;a<=e;a++,c++)o=h*Math.exp(s*a*a),g[c]=o,w+=o;for(c=0,d=g.length;c<d;c++)g[c]/=w;for(n=0;n<p;n++)for(a=0;a<v;a++){for(i=o=s=h=0,w=0,u=-e;u<=e;u++)(f=a+u)>=0&&f<v&&(c=4*(n*v+f),i+=l[c]*g[u+e],o+=l[c+1]*g[u+e],s+=l[c+2]*g[u+e],w+=g[u+e]);l[c=4*(n*v+a)]=i/w,l[c+1]=o/w,l[c+2]=s/w}for(a=0;a<v;a++)for(n=0;n<p;n++){for(i=o=s=h=0,w=0,u=-e;u<=e;u++)(f=n+u)>=0&&f<p&&(c=4*(f*v+a),i+=l[c]*g[u+e],o+=l[c+1]*g[u+e],s+=l[c+2]*g[u+e],w+=g[u+e]);l[c=4*(n*v+a)]=i/w,l[c+1]=o/w,l[c+2]=s/w}return t.data=l,t}}}),window.psLib.module("Filter.ImageEnhance",function(t){return{process:function(t,e,r){arg;for(var a=t.data,n=(t.width,t.height,0),i=a.length;n<i;n+=4);return t.data=a,t}}}),window.psLib.module("Filter.borderline",function(t){return{process:function(e,r){var a=[0,1,0,1,-4,1,0,1,0];return t.lib.dorsyMath.applyMatrix(e,a,250)}}}),window.psLib.module("Filter.mosaic",function(t){return{process:function(t,e){for(var r=parseInt(e[0])||3,a=t.data,n=t.width,i=t.height,o=2*r+1,s=0,h=parseInt(n/o);s<h;s++)for(var c=0,u=parseInt(i/o);c<u;c++){for(var f=[],d=[0,0,0],l=0;l<o;l++)for(p=0;p<o;p++){var v=(c*o+l)*n+s*o+p;d[0]+=a[4*v],d[1]+=a[4*v+1],d[2]+=a[4*v+2]}f[0]=d[0]/(o*o),f[1]=d[1]/(o*o),f[2]=d[2]/(o*o);for(l=0;l<o;l++)for(var p=0;p<o;p++)a[4*(v=(c*o+l)*n+s*o+p)]=f[0],a[4*v+1]=f[1],a[4*v+2]=f[2]}return t}}}),window.psLib.module("Filter.noise",function(t){return{process:function(t,e){for(var r=parseInt(e[0])||100,a=t.data,n=t.width,i=t.height,o=0;o<n;o++)for(var s=0;s<i;s++)for(var h=s*n+o,c=0;c<3;c++){var u=parseInt(Math.random()*r*2)-r;a[4*h+c]+=u}return t}}}),window.psLib.module("Filter.oilPainting",function(t){return{process:function(t,e){for(var r=parseInt(e[0])||16,a=t.data,n=t.width,i=t.height,o=0;o<n;o++)for(var s=0;s<i;s++){for(var h=s*n+o,c=0,u=0;u<3;u++)c+=a[4*h+u];c/=3;for(var f=parseInt(c/r)*r,u=0;u<3;u++)a[4*h+u]=f}return t}}}),window.psLib.module("Filter.posterize",function(t){return{process:function(e,r){var a=t.lib.dorsyMath,n=(e.data,e.width),i=e.height,o=r[0]||20;o=o<1?1:o>255?255:o;for(var s=Math.floor(255/o),h=0;h<n;h++)for(var c=0;c<i;c++)a.xyCal(e,h,c,function(t,e,r){return[Math.floor(t/s)*s,Math.floor(e/s)*s,Math.floor(r/s)*s]});return e}}}),window.psLib.module("Filter.sepia",function(t){return{process:function(e){for(var r=t.lib.dorsyMath,a=(e.data,e.width),n=e.height,i=0;i<a;i++)for(var o=0;o<n;o++)r.xyCal(e,i,o,function(t,e,r){return[.393*t+.769*e+.189*r,.349*t+.686*e+.168*r,.272*t+.534*e+.131*r]});return e}}}),window.psLib.module("Filter.sharp",function(t){return{process:function(t,e){for(var r=e[0]||.6,a=t.data,n=t.width,i=(t.height,0),o=a.length;i<o;i+=4){var s=i/4,h=parseInt(s/n),c=s%n;if(0!=h&&0!=c)for(var u=4*((h-1)*n+(c-1)),f=4*((h-1)*n+c),d=4*(s-1),l=0;l<3;l++){var v=a[i+l]-(a[f+l]+a[d+l]+a[u+l])/3;a[i+l]+=v*r}}return t}}}),window.psLib.module("Filter.toGray",function(t){return{process:function(t){for(var e=t.data,r=0,a=e.length;r<a;r+=4){var n=parseInt(.299*e[r]+.578*e[r+1]+.114*e[r+2]);e[r+2]=e[r+1]=e[r]=n}return t.data=e,t}}}),window.psLib.module("Filter.toReverse",function(t){return{process:function(t){for(var e=t.data,r=0,a=e.length;r<a;r+=4)e[r]=255-e[r],e[r+1]=255-e[r+1],e[r+2]=255-e[r+2];return t.data=e,t}}}),window.psLib.module("Filter.toThresh",function(t){return{process:function(e,r){for(var a=(e=t.reflect("toGray",e)).data,r=r[0]||128,n=0,i=a.length;n<i;n++)(n+1)%4&&(a[n]=a[n]>r?255:0);return e.data=a,e}}});