!function(t){var e=function(){var t;try{t=new XMLHttpRequest}catch(e){try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){return!1}}}return t},i=function(t,e){var i="";for(var o in e)i+="var "+o+" = data."+o+";";return t=i+"var __result = ''; ?>"+(t=t.replace(/\s+/g," "))+"<?",t=(t+=" return __result;").replace(/<\?=([^\?]+)\?>/g,"' + $1 + '").replace(/<\?/gi,"';").replace(/\?>/g,"__result += '"),new Function("data",t)(e)},o={},n=function(){function t(t,e,i){var n=t+"_"+e;o[n]||(o[n]=[]),o[n].push(i)}return window.addEventListener?function(e,i,o){e.addEventListener(i,o,!1),e.id&&t(e.id,i,o)}:function(e,i,o){e.attachEvent("on"+i,o),e.id&&t(e.id,i,o)}}(),l=(window.addEventListener,{request:function(t){console.log("Proxy starts creating Ajax!!");var i=e(),o=t.success,n=t.url,l=t.method,r=t.data,a=[];for(var s in r)a.push(s+"="+r[s]);"GET"==l&&(n+="?"+a.join("&")),i?(i.onreadystatechange=function(){4==this.readyState&&(console.log("Proxy Ajax loaded!!"),o&&o(i.responseText))},i.open(l,n,!1),i.send(JSON.stringify(r)),console.log("Proxy created Ajax done!!method: "+l+"; data: "+JSON.stringify(r)+"----already send")):console.error("Proxy created Ajax Error!!")},getTmpl:i,renderTmpl:function(t,e){var o=document.getElementById(t),n=o.innerHTML,l=i(n,e),r=document.createElement("div");r.innerHTML=l;for(var a=r.childNodes;a.length>0;)o.parentNode.insertBefore(a[0],o)},addEvent:function(t,e,i,o){var n="",l=0;if("string"==typeof e)switch(l=1,!0){case/^\./.test(e):n="className",e=e.replace(".",""),e=new RegExp(" *"+e+" *");break;case/^\#/.test(e):n="id",e=new RegExp(e.replace("#",""));break;default:e=new RegExp(e),n="tagName"}var r=window.addEventListener?"addEventListener":"attachEvent",i=window.addEventListener?i:"on"+i;t[r](i,function(i){function r(a){if(l){var s;if(s="tagName"==n?a.tagName.toLowerCase():a[n],e.test(s))return void o.call(a,i)}else if(e==a)return void o.call(a,i);a!=t&&a.parentNode!=t&&a.parentNode&&r(a.parentNode)}r(i.srcElement)})},animate:function(t,e,i,o){var n=60,l={},r={};for(var a in e){var s=parseInt(this.css(t,a));r[a]=s,l[a]=parseInt(parseInt(e[a])-s)/i}var f,p=0;return f=setInterval(function(){var e=function(t,e,i,o,n){return.3*Math.pow(1-t,3)+3*i*t*Math.pow(1-t,2)+3*o*t*t*(1-t)+n*Math.pow(t,3)}(++p/n*1e3/i,0,.82,1,1)*i;for(var a in l)t.style[a]="opacity"==a?r[a]+l[a]*e:r[a]+l[a]*e+"px";p==i/1e3*n&&(clearInterval(f),o&&o())},1e3/n),{stop:function(){clearInterval(f)}}},css:function(t,e){return t.style[e]?t.style[e]:getComputedStyle(t).getPropertyValue(e)},bind:n});window.AlloyClipTools={Utils:l}}(),function(){var t=window.AlloyClipTools.Utils,e=function(t,e,i){if(i&&"string"!=typeof i){n=document.createElement(t);for(var o in e)"className"!=o&&"id"!=o?n.setAttribute(o,e[o]):n[o]=e[o];return i&&i.appendChild(n),n}var n=document.createElement(t);return e&&e.appendChild(n),i&&(n.className=i),n},i=function(t,i,o,n,l){i=i||80,o=o||80,this.defaultWidth=i,this.defaultHeight=o;var r=this;this.el=t,this.BORder=l,this.setting={},this.status={},this.eventPool={},this.setting.isFixed=n,this.imgBoundInfo={},this.clipInfo={};var a=document.createDocumentFragment(),s=e("div",a,"AlloyClipWapper"),f=e("div",s,"AlloyClipLeftWrapper"),p=e("div",s,"AlloyClipRight"),d=e("div",f,"AlloyClipLeft"),c=e("div",f,"AlloyClipOptionWrapper");this.left=d,this.right=p,this.optionWrapper=c;e("div",d,"AlloyClipButtonTop");var u=e("div",d,"AlloyClipButton"),h=e("div",d,"AlloyCliptip"),g=e("div",d,"AlloyCanvasWrapper"),y=(e("div",d,"AlloyClipButtonTop"),e("div",d,"AlloyClipMask"));u.innerHTML='<i class="fa fa-upload" aria-hidden="true"></i> 上传图片',h.innerHTML="<p>选择图片 → 裁剪 → 加边框及色域调节 → 加文字及其他素材 → 下载保存</p>",$(h).css({paddingTop:"20px",color:"#333"}),g.id="AlloyCanvasWrapper",g.style.display="none";var v=e("input",document.body,"AlloyClipInputFile");v.style.display="none",v.type="file";var m=e("div",p,"AlloyClipRightTitle"),x=e("div",p,"AlloyClipRightContent"),I=e("div",p,"AlloyClipRightInfo"),w=e("div",p,"AlloyClipSwitchPic"),L=e("div",p,"AlloyClipConfim");L.onclick=function(){for(var t=r.eventPool.ok||[],e=r.psedAIPic.save(),i=0;i<t.length;i++)t[i](e,r.psedAIPic)},m.innerHTML='<i class="fa fa-eye" aria-hidden="true"></i> 预览',I.innerHTML=i+"×"+o+" (px)",L.innerHTML='<i class="fa fa-check-square-o" aria-hidden="true"></i> 确定',w.innerHTML='<i class="fa fa-exchange" aria-hidden="true"></i> 切换图片',I.style.display="none",this.rightInfo=I,this.rightContent=x,this.switchPic=w,p.style.width="440px",t.appendChild(a),this.hideUploadBox=function(){u.style.display="none",h.style.display="none"},this.showCanvas=function(t){g.innerHTML="",g.style.display="",g.appendChild(t)},this.showMask=function(){y.style.display="block"},this.hideMask=function(){y.style.display="none"},this.canvasWrapper=g,u.onclick=function(){v.click()},w.onclick=function(){v.click()},v.onchange=function(t){var e=t.target.files[0],i=new FileReader;i.readAsDataURL(e),i.onload=function(){var t=new Image;t.onload=function(){r.imgEl=this,r.originAILayer=$AI(this),r.hideUploadBox(),r.showCanvas(this),r.showMask(),r.alterImgPositon(this),r.getRect().init(),r.showClipPic(),L.style.display="block",w.style.display="block",n&&r.fixedInit(),r.getOption()},t.src=this.result}},this.rect=null,this.uid="AlloyClip_"+~~(1e6*Math.random())};i.prototype={constructor:i,fileHandler:function(t){this.hideUploadBox(),this.showCanvas()},fixedInit:function(){this.imgEl.style.position="absolute",this.imgEl.style.left=this.imgBoundInfo.offsetLeft+"px",this.imgEl.style.top=this.imgBoundInfo.offsetTop+"px",this.bindFixedEvent()},bindFixedEvent:function(){var e,i,o,n,l=this,r=0;this.left.onmousedown=function(t){e=parseInt(l.imgEl.style.left),i=parseInt(l.imgEl.style.top),o=t.pageX,n=t.pageY,r=1,t.preventDefault()},t.addEvent(l.el,this.left,"mousemove",function(t){var a,s;if(r){a=t.pageX-o,s=t.pageY-n;var f=e+a,p=i+s;l.imgEl.style.left=~~f+"px",l.imgEl.style.top=~~p+"px",l.getRect().setBackgroundPosition(),l.showClipPic(),t.preventDefault()}}),l.el.addEventListener("mouseup",function(t){r=0});var a=function(t,e){var i=l.imgEl.offsetWidth,o=l.imgEl.offsetHeight,n=t[0],r=t[1],a=n*e-n,s=r*e-r,f=parseInt(l.imgEl.style.left)-a,p=parseInt(l.imgEl.style.top)-s,d=i*e,c=o*e;l.imgEl.style.width=~~d+"px",l.imgEl.style.height=~~c+"px",l.imgEl.style.left=~~f+"px",l.imgEl.style.top=~~p+"px",l.imgBoundInfo.width=d,l.imgBoundInfo.height=c,l.getRect().init(),l.showClipPic()};this.left.addEventListener("mousewheel",function(t){if(t.target.className&&"AlloyClipRect"==t.target.className)e=[t.offsetX+t.target.offsetLeft-l.imgEl.offsetLeft,t.offsetY+t.target.offsetTop-l.imgEl.offsetTop];else var e=[t.offsetX-l.imgEl.offsetLeft,t.offsetY-l.imgEl.offsetTop];t.wheelDeltaY<0?a(e,.8):a(e,1.2)})},alterImgPositon:function(t){var e=t.width,i=t.height;t.style.width="0px",t.style.height="0px";var o,n,l=t.parentNode.parentNode.offsetWidth,r=t.parentNode.parentNode.offsetHeight,a=e/i;l/r>a?(o=r*a,n=r,t.style.width=~~o+"px",t.style.height="auto",~~((l-o)/2)):(t.style.height="auto",t.style.width="100%",o=l,0,n=l/a),this.imgBoundInfo.offsetLeft=t.offsetLeft,this.imgBoundInfo.offsetTop=t.offsetTop,this.imgBoundInfo.width=o,this.imgBoundInfo.height=n},getOption:function(){var i=this;return this.optionEl||function(){i.status.currOper="alterationHandler";var o={},n=e("div",i.optionWrapper,"AlloyClipOptionBar"),l=e("div",i.optionWrapper,"AlloyClipOptionPW"),r=e("ul",n,"AlloyClipNav");r.innerHTML="<li id='alteration'><i class=\"fa fa-adjust\"></i> 调节</li><li id='filter'><i class=\"fa fa-filter\"></i> 滤镜</li><li id='border'><i class=\"fa fa-object-group\"></i> 边框</li>";var a=e("div",n,"AlloyClipOptionController");if(i.isFixed){var s=e("span",a,"AlloyClipCItem"),f=e("span",a,"AlloyClipCItem");s.innerHTML="+",f.innerHTML="-"}var p=e("span",a,"AlloyClipCItem");p.innerHTML='旋转 <i class="fa fa-repeat" aria-hidden="true"></i>',p.style.fontSize="14px",p.onclick=function(){i.originAILayer.rotate(90).replace(i.imgEl),i.alterImgPositon(i.imgEl),i.getRect().init(),i.showClipPic()};var d=function(){"filterHandler"!=i.status.currOper&&i.psedAIPic&&(i.currLayer=i.psedAIPic),i.status.currOper="filterHandler",l.innerHTML="";var t=e("ul",l,"AlloyClipFilter"),o=["sketch","lomo","soften","softenFace","purpleStyle","vintage","warmAutumn","rough","softEnhancement"],n=l.offsetHeight,r=.7*n;t.style.paddingTop=~~(.15*n)+"px";for(var a=i.currLayer.width,s=(i.currLayer.height,r/a),f=i.currLayer.clone().scale(s),p=0;p<o.length;p++){var d=o[p],c=e("li",t);f.clone().ps(d).show(c),c.onclick=function(t){return function(){i.psedAIPic=i.currLayer.clone().ps(t).replaceChild(i.rightContent)}}(d)}},c=function(){"borderHandler"!=i.status.currOper&&i.psedAIPic&&(i.currLayer=i.psedAIPic),i.status.currOper="borderHandler",l.innerHTML="";for(var t=e("ul",l,"AlloyClipFilter AlloyClipBorder"),o=i.BORder,n=(i.currLayer.width,i.currLayer.height,i.currLayer.clone().scaleTo(null,50)),r=0;r<o.length;r++){var a=o[r],s=e("li",t),f=new Image;f.onload=function(t){return function(){var e=$AI(this);e.scaleTo(n.width,n.height),n.clone().add(e.clone()).show(t)}}(s),f.src=a,s.onclick=function(t){return function(){var e=new Image;e.onload=function(){var t=$AI(this);t.scaleTo(i.currLayer.width,i.currLayer.height),i.psedAIPic=i.currLayer.clone().add(t.clone()).replaceChild(i.rightContent)},e.src=t}}(a)}},u=function(t){"alterationHandler"!=i.status.currOper&&i.psedAIPic&&(i.currLayer=i.psedAIPic),i.status.currOper="alterationHandler",l.innerHTML="";var o=e("ul",l,"AlloyClipFilter AlloyClipAlter"),n=function(){},r=i.getScrollBar(160,.5,"色相","apH",n),a=i.getScrollBar(160,.5,"饱和度","apS",n),s=i.getScrollBar(160,.5,"亮度","apI",n),f=i.getScrollBar(160,.5,"对比度","apD",n);o.appendChild(r),o.appendChild(a),o.appendChild(s),o.appendChild(f),i.status.currOperation="Alteration",i.status.toolBarValue={Alteration:[.5,.5,.5,.5]}};return t.addEvent(r,"li","click",function(t){switch(this.id){case"filter":d();break;case"border":c();break;case"alteration":u()}}),i.bindScrollBarEvent(),n.appendChild(i.switchPic),i.optionEl=o,o.doCurrOptionPro=function(){switch(i.status.currOper){case"filterHandler":d();break;case"borderHandler":c();break;case"alterationHandler":u()}},o}()},getScrollBar:function(t,i,o,n,l){var t=t||200,i=i||.5,o=o||"",r=this.uid,a=document.createElement("li");a.className="apScrollBarWrapper";var s=e("div",{className:"apBarTitle"},a),f=e("div",{className:"apBarContent"},a),p=e("div",{className:"apBarLineLeft"},f),d=e("div",{className:"apBarScrollEl","data-uid":r,id:n},f),c=e("div",{className:"apBarLineRight"},f);return s.innerHTML=o,p.style.width=i*t+"px",c.style.width=(1-i)*t+"px",d.style.left=i*t-15+"px",a},bindScrollBarEvent:function(t){var e,i,o,n=this,l=0,r=0,a=0,s=0,f=0,t=t||160,p=p||30,d=.5;n.el.addEventListener("mousedown",function(t){var p=t.target;if("apBarScrollEl"==p.className){if(p.getAttribute("data-uid")!=n.uid)return;l=1,i=(e=p).parentNode.childNodes[0],o=e.parentNode.childNodes[2],r=t.pageX,a=t.pageY,s=p.offsetLeft,f=p.offsetTop}t.preventDefault()},!1),n.el.addEventListener("mouseup",function(t){if(l){var i=e.id,o=n.currLayer.clone();if("Alteration"==n.status.currOperation){"apH"==i?n.status.toolBarValue.Alteration[0]=d:"apS"==i?n.status.toolBarValue.Alteration[1]=d:"apI"==i?n.status.toolBarValue.Alteration[2]=d:"apD"==i&&(n.status.toolBarValue.Alteration[3]=d),l=0;var r=n.status.toolBarValue.Alteration;if("apD"==i){var a=r[3];a=100*(a-.5),o.act("brightness",0,a).replaceChild(n.rightContent)}else{var s=r[0],f=r[1],p=r[2];s=360*(s-.5),f=100*(f-.5),p=100*(p-.5),o.act("setHSI",s,f,p,0).replaceChild(n.rightContent)}}}l=0},!1),n.el.addEventListener("mousemove",function(n){n.target;if(l){var a=n.pageX,f=(n.pageY,s+(a-r));if((d=(f+p/2)/t)>1||d<0)return;e.style.left=f+"px",i.style.width=t*d+"px",o.style.width=t*(1-d)+"px",n.preventDefault()}},!1)},getRect:function(){var i=this;return this.rect||function(){var o=e("div",i.left,"AlloyClipRect");o.style.width=i.defaultWidth/4+"px",o.style.height=i.defaultHeight/4+"px";var n,l,r,a,s,f,p,d=e("div",o,"AlloyBgImgWrapper"),c=e("img",d,"AlloyBgImg"),u=function(){o.style.width=i.defaultWidth/4+"px",o.style.height=i.defaultHeight/4+"px";var t=i.left.offsetWidth,e=i.left.offsetHeight,n=~~((t-i.defaultWidth/4)/2)+"px",l=~~((e-i.defaultHeight/4)/2)+"px";o.style.left=n,o.style.top=l},h=o.offsetWidth/o.offsetHeight,g=[{position:"top left",left:"0px",top:"0px"},{position:"top right",right:"0px",top:"0px"},{position:"bottom left",bottom:"0px",left:"0px"},{position:"bottom right",bottom:"0px",right:"0px"}],y=0,v=0,m=function(){var t=i.imgEl.offsetLeft,e=i.imgEl.offsetTop,n=2+~~(o.offsetLeft-t),l=2+~~(o.offsetTop-e);c.style.left=-n+"px",c.style.top=-l+"px",i.clipInfo.left=n,i.clipInfo.top=l,i.clipInfo.width=o.offsetWidth,i.clipInfo.height=o.offsetHeight},x=function(t,e,n,l){var p,d;p=void 0!=t?t:s,d=void 0!=e?e:f;var c=n||r,u=l||a,g=~~(i.imgBoundInfo.offsetLeft+i.imgBoundInfo.width),y=~~(i.imgBoundInfo.offsetTop+i.imgBoundInfo.height);if(n){if(void 0!=t&void 0!=e){var v=s+r,m=f+a;if(d<i.imgBoundInfo.offsetTop){I=i.imgBoundInfo.offsetTop;return(x=v-(L=(w=m-i.imgBoundInfo.offsetTop)*h))<i.imgBoundInfo.offsetLeft&&(I=m-(w=(L=v-i.imgBoundInfo.offsetLeft)/h),x=v-L),o.style.top=~~I+"px",o.style.left=~~x+"px",o.style.width=~~L+"px",void(o.style.height=~~w+"px")}if(v-c<i.imgBoundInfo.offsetLeft){x=v-(L=v-i.imgBoundInfo.offsetLeft);return(I=m-(w=L/h))<i.imgBoundInfo.offsetHeight&&(x=v-(L=(w=m-(I=i.imgBoundInfo.offsetHeight))*h)),o.style.top=~~I+"px",o.style.left=~~x+"px",o.style.width=~~L+"px",void(o.style.height=~~w+"px")}}else if(void 0!=t){var v=s+r,m=f;if(d+u>y)return(x=v-(L=(w=y-d)*h))<i.imgBoundInfo.offsetLeft&&(w=(L=v-(x=i.imgBoundInfo.offsetLeft))/h),o.style.left=~~x+"px",o.style.width=~~L+"px",void(o.style.height=~~w+"px");if(p<i.imgBoundInfo.offsetLeft){var x=i.imgBoundInfo.offsetLeft;d+(w=(L=v-i.imgBoundInfo.offsetLeft)/h)>y&&(L=(w=y-d)*h),o.style.left=~~x+"px",o.style.width=~~L+"px",o.style.height=~~w+"px"}}else if(void 0!=e){var v=s,m=f+a;if(d<i.imgBoundInfo.offsetTop){var I=i.imgBoundInfo.offsetTop;return p+(L=(w=m-i.imgBoundInfo.offsetTop)*h)>g&&(I=m-(w=(L=g-p)/h)),o.style.top=~~I+"px",o.style.width=~~L+"px",void(o.style.height=~~w+"px")}if(v+c>g)return(I=m-(w=(L=g-v)/h))<i.imgBoundInfo.offsetHeight&&(L=(w=m-(I=i.imgBoundInfo.offsetHeight))*h),o.style.top=~~I+"px",o.style.width=~~L+"px",void(o.style.height=~~w+"px")}else if(p+c>g)d+(w=(L=g-p)/h)>y&&(L=(w=y-d)*h),o.style.width=~~L+"px",o.style.height=~~w+"px";else if(d+u>y){var w=y-d,L=w*h;p+L>g&&(w=(L=g-p)/h),o.style.width=~~L+"px",o.style.height=~~w+"px"}}else p<i.imgBoundInfo.offsetLeft&&(o.style.left=~~i.imgBoundInfo.offsetLeft+"px"),d<i.imgBoundInfo.offsetTop&&(o.style.top=~~i.imgBoundInfo.offsetTop+"px"),p+c>g&&(o.style.left=~~(g-c)+"px"),d+u>y&&(o.style.top=~~(y-u)+"px")},I=function(){c.src=i.imgEl.src,c.style.width=i.imgBoundInfo.width+"px",c.style.height=i.imgBoundInfo.height+"px",m()};if(i.setting.isFixed||t.addEvent(i.el,o,"mousedown",function(t){y=1,n=t.pageX,l=t.pageY,s=o.offsetLeft,f=o.offsetTop,r=o.offsetWidth,a=o.offsetHeight}),!i.setting.isFixed)for(var w=0;w<g.length;w++){for(var L=e("div",o,"AlloyClipControl"),C=["left","right","top","bottom"],A=0;A<C.length;A++){var B=C[A];g[w][B]&&(L.style[B]=~~g[w][B]-10+"px")}t.addEvent(i.left,L,"mousedown",function(t){return function(e){v=1,o.style.webkitTransformOrigin=g[g.length-1-t].position,n=e.pageX,l=e.pageY,r=o.offsetWidth,a=o.offsetHeight,s=o.offsetLeft,f=o.offsetTop,p=t,e.stopPropagation()}}(w))}return i.el.addEventListener("mousemove",function(t){var e=t.pageX,i=t.pageY;if(v){t.preventDefault();var a=(I=e-n)/h;if(3==p){d=(g=r+I)/h;if(g<0||d<0)return;o.style.width=g+"px",o.style.height=d+"px",x(null,null,g,d)}else if(2==p){var d=(g=-I+r)/h,c=s+I;if(g<0||d<0)return;o.style.width=g+"px",o.style.height=d+"px",o.style.left=c+"px",x(c,null,g,d)}else if(1==p){var d=(g=r+I)/h,u=f-a;if(g<0||d<0)return;o.style.width=g+"px",o.style.height=d+"px",o.style.top=u+"px",x(null,u,g,d)}else if(0==p){var g=r-I,d=g/h,c=s+I,u=f+a;if(g<0||d<0)return;o.style.width=g+"px",o.style.height=d+"px",o.style.left=c+"px",o.style.top=u+"px",x(c,u,g,d)}m()}else if(y){t.preventDefault();var I=e-n,c=s+I,u=f+(i-l);o.style.left=c+"px",o.style.top=u+"px",x(c,u),m()}}),i.el.addEventListener("mouseup",function(t){(v||y)&&i.showClipPic(),v=0,y=0}),i.rect=o,o.init=function(){u(),I()},o.setBackgroundPosition=m,o}()},showClipPic:function(){var t=$AI(this.imgEl),e=this.clipInfo,i=this.defaultWidth/e.width,o=this.defaultHeight/e.height;this.currLayer=t.clip(e.left,e.top,e.width,e.height).scale(i,o).replaceChild(this.rightContent),this.psedAIPic=this.currLayer,this.rightInfo.style.display="",this.getOption().doCurrOptionPro()},addEventListener:function(t,e){this.eventPool[t]||(this.eventPool[t]=[]),this.eventPool[t].push(e)}};$AC=AlloyClip=function(t,e,o,n,l){if("object"!=typeof t){for(var r=document.querySelectorAll(t),a={},s=[],f=0;f<r.length;f++)s.push(new i(r[f],e,o,n,l));return a.ok=function(t){for(var e=0;e<s.length;e++)s[e].addEventListener("ok",function(e,i){t&&t(e,i)})},a}}}();